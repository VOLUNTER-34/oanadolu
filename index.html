<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anatolia Bus Manager - V6 (Şehir İçi)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        // Firebase SDK'ları
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, serverTimestamp, writeBatch, setLogLevel, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase yapılandırması (KULLANICI TARAFINDAN SAĞLANAN)
        const firebaseConfig = {
            apiKey: "AIzaSyBB111k-Rcl47cTxTgddUDHiDSV_sCmcO4", // GERÇEK API KEY'İNİZİ GİRİN
            authDomain: "anatolia-bus-manager.firebaseapp.com",
            projectId: "anatolia-bus-manager",
            storageBucket: "anatolia-bus-manager.firebasestorage.app",
            messagingSenderId: "821967295523",
            appId: "1:821967295523:web:63b19e0bc671f544b4cd96"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Firestore log seviyesi

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'anatolia-bus-manager-no-map';
        let userId = null; 
        let playerDocRef = null;
        let playerUnsubscribe = null; 

        const STANDART_KM_BASINA_FIYAT_SEHIRLERARASI = 0.25; 
        const STANDART_FIYAT_SEHIRICI = 50; 
        const EVENT_TRIGGER_CHANCE_PER_HOUR = 0.15;

        function formatFirestoreTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) {
                return 'Bilinmiyor';
            }
            return timestamp.toDate().toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function formatGameDate(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                 return 'Tarih Bilinmiyor';
            }
            return date.toLocaleString('tr-TR', {
                year: 'numeric', month: 'long', day: 'numeric', 
                hour: '2-digit', minute: '2-digit', weekday: 'long'
            });
        }

        class Otogar {
            constructor(sehir, ad, yolcuKapasitesi, otobusKapasitesi, imageUrl, acmaUcreti = 0) {
                this.sehir = sehir;
                this.ad = ad;
                this.yolcuKapasitesi = yolcuKapasitesi;
                this.otobusKapasitesi = otobusKapasitesi;
                this.imageUrl = imageUrl;
                this.acikMi = false; 
                this.acmaUcreti = acmaUcreti; 
            }
            toString() {
                return `${this.sehir} - ${this.ad}`;
            }
        }
        
        class Durak {
            constructor(ilce, ad) {
                this.ilce = ilce;
                this.ad = ad;
            }
             toString() {
                return `${this.ilce} - ${this.ad}`;
            }
        }

        class Sofor {
            static _sofor_id_sayaci = 1;
            constructor(adSoyad, deneyimSeviyesi, maas, yetenekler, iseAlimUcreti, imageUrl = null) {
                this.id = `sofor_${Sofor._sofor_id_sayaci++}`;
                this.adSoyad = adSoyad;
                this.deneyimSeviyesi = deneyimSeviyesi;
                this.maas = maas; 
                this.deneyimPuani = 0;
                this.seviyeAtlamaXp = { 1: 100, 2: 300, 3: 700, 4: 1500, 5: 3000 };
                this.yetenekler = {
                    yakitTasarrufu: yetenekler.yakitTasarrufu || 0, 
                    hizBonusu: yetenekler.hizBonusu || 0, 
                    dayaniklilik: yetenekler.dayaniklilik || 6, 
                };
                this.durum = "Boşta"; 
                this.atananOtobusId = null;
                this.yorgunluk = 0; 
                this.iseAlimUcreti = iseAlimUcreti;
                this.imageUrl = imageUrl || `https://placehold.co/80x80/4A5568/E2E8F0?text=${adSoyad.substring(0,1)}`;
            }

            gerekliXpHesapla() {
                return this.seviyeAtlamaXp[this.deneyimSeviyesi] || 99999;
            }

            deneyimKazan(puan) {
                this.deneyimPuani += puan;
                game.logMessage(`${this.adSoyad}, ${puan} deneyim puanı kazandı.`, "info");
                while(this.deneyimPuani >= this.gerekliXpHesapla() && this.deneyimSeviyesi < 5) {
                    this.deneyimSeviyesi++;
                    this.maas = Math.floor(this.maas * 1.15);
                    this.yetenekler.yakitTasarrufu += 1;
                    this.yetenekler.hizBonusu += 1;
                    this.yetenekler.dayaniklilik = Math.min(10, this.yetenekler.dayaniklilik + 1);
                    game.logMessage(`TEBRİKLER! ${this.adSoyad}, ${this.deneyimSeviyesi}. seviyeye ulaştı! Maaşı ${this.maas.toLocaleString()} TL oldu.`, "warning");
                }
            }

            static fromFirestore(data) {
                const sofor = new Sofor(
                    data.adSoyad || "Bilinmeyen Şoför",
                    data.deneyimSeviyesi || 1,
                    data.maas || 0,
                    data.yetenekler || { yakitTasarrufu: 0, hizBonusu: 0, dayaniklilik: 6 },
                    data.iseAlimUcreti || 0,
                    data.imageUrl
                );
                sofor.id = data.id || `sofor_${Sofor._sofor_id_sayaci++}`; 
                sofor.durum = data.durum || "Boşta";
                sofor.atananOtobusId = data.atananOtobusId || null;
                sofor.yorgunluk = data.yorgunluk || 0;
                sofor.deneyimPuani = data.deneyimPuani || 0;
                return sofor;
            }

            toFirestore() {
                 const cleanNumber = (val, defaultVal = 0) => (typeof val === 'number' && isFinite(val)) ? val : defaultVal;
                return {
                    id: this.id,
                    adSoyad: this.adSoyad,
                    deneyimSeviyesi: cleanNumber(this.deneyimSeviyesi, 1),
                    maas: cleanNumber(this.maas),
                    deneyimPuani: cleanNumber(this.deneyimPuani),
                    yetenekler: {
                        yakitTasarrufu: cleanNumber(this.yetenekler.yakitTasarrufu),
                        hizBonusu: cleanNumber(this.yetenekler.hizBonusu),
                        dayaniklilik: cleanNumber(this.yetenekler.dayaniklilik, 6)
                    },
                    durum: this.durum || "Boşta",
                    atananOtobusId: this.atananOtobusId || null,
                    yorgunluk: cleanNumber(this.yorgunluk),
                    iseAlimUcreti: cleanNumber(this.iseAlimUcreti),
                    imageUrl: this.imageUrl
                };
            }
        }

        class Bus {
            static _otobus_id_sayaci = 1;
            constructor(marka, model, fiyat, hiz, yakitKapasitesi, yolcuKapasitesi, dukkanOtobusu = false, imageUrl = null, seviyeGereksinimi = 1) {
                if (!dukkanOtobusu) {
                    this.id = Bus._otobus_id_sayaci++;
                } else {
                    this.id = -1; 
                    this.imageUrl = imageUrl; 
                    this.seviyeGereksinimi = seviyeGereksinimi; 
                }
                this.marka = marka;
                this.model = model;
                this.fiyat = fiyat; 
                this.hiz = (typeof hiz === 'number' && isFinite(hiz)) ? hiz : 0; 
                this.yakitKapasitesi = (typeof yakitKapasitesi === 'number' && isFinite(yakitKapasitesi)) ? yakitKapasitesi : 0; 
                this.yakitSeviyesi = this.yakitKapasitesi; 
                this.yolcuKapasitesi = (typeof yolcuKapasitesi === 'number' && isFinite(yolcuKapasitesi)) ? yolcuKapasitesi : 0; 
                this.durum = "garajda"; 
                this.konum = null; 
                this.mevcutRota = null; 
                this.atananSoforId = null; 

                this.donanim = { wifi: false, konfor: false, tv: false };
                this.donanimMaliyetleri = { wifi: 20000, konfor: 50000, tv: 35000 };
                
                this.seatConfig = { standard: this.yolcuKapasitesi, business: 0 };
                this.modificationCost = 120000;
            }
            
            get totalCapacity() {
                return this.seatConfig.standard + this.seatConfig.business;
            }

            getMemnuniyetBonusu(seatClass = 'standard') {
                let bonus = 1.0;
                if (this.donanim.wifi) bonus += 0.08;
                if (this.donanim.konfor) bonus += 0.15;
                if (this.donanim.tv) bonus += 0.12;
                
                if (seatClass === 'business') {
                    bonus += 0.35; // Business class koltuklar için ekstra memnuniyet
                }
                return bonus;
            }
            
            getFiyatArtisCarpanı() {
                let carpan = 1.0;
                if (this.donanim.wifi) carpan += 0.05;
                if (this.donanim.konfor) carpan += 0.15;
                if (this.donanim.tv) carpan += 0.10;
                return carpan;
            }

            yukselt(donanimTipi) {
                if (!game.player) return;
                if (this.donanim[donanimTipi]) {
                    game.logMessage("Bu donanım zaten mevcut.", "info");
                    return;
                }
                const maliyet = this.donanimMaliyetleri[donanimTipi];
                if (game.player.para >= maliyet) {
                    game.player.para -= maliyet;
                    this.donanim[donanimTipi] = true;
                    game.recordExpense('maintenance', maliyet);
                    game.logMessage(`${this.marka} ${this.model} için ${donanimTipi.toUpperCase()} donanımı ${maliyet.toLocaleString()} TL karşılığında takıldı!`, "success");
                    game.updateGarajListesi();
                    game.savePlayerData();
                } else {
                    game.logMessage(`Donanım için yeterli para yok. Gerekli: ${maliyet.toLocaleString()} TL`, "warning");
                }
            }
            
            modifySeatsToBusiness(count) {
                if (!game.player) return;
                const cost = count * this.modificationCost;
                const standardSeatsToRemove = count * 2; 

                if (this.seatConfig.standard < standardSeatsToRemove) {
                    game.logMessage("Yeterli standart koltuk yok.", "warning");
                    return;
                }
                if (game.player.para < cost) {
                    game.logMessage(`Modifikasyon için yeterli para yok. Gerekli: ${cost.toLocaleString()} TL`, "warning");
                    return;
                }
                
                game.player.para -= cost;
                this.seatConfig.standard -= standardSeatsToRemove;
                this.seatConfig.business += count;
                game.recordExpense('maintenance', cost);
                game.logMessage(`${this.marka} ${this.model}, ${count} business koltuk eklenerek modifiye edildi. Maliyet: ${cost.toLocaleString()} TL`, "success");
                game.savePlayerData();
                game.updateGarajListesi();
                game.closeModal('modalBusModify');
            }

            yakitTuketimiHesapla(mesafe, rota = null) {
                const safeMesafe = (typeof mesafe === 'number' && isFinite(mesafe)) ? mesafe : 0;
                let tuketimCarpanı = 1.0;

                const sofor = game.player?.personelListesi?.find(s => s.id === this.atananSoforId);
                if(sofor && sofor.yetenekler && typeof sofor.yetenekler.yakitTasarrufu === 'number'){
                    tuketimCarpanı -= (sofor.yetenekler.yakitTasarrufu / 100);
                }
                
                if(rota) {
                    const event = game.getEventForRoute(rota.kalkisNoktasi.ad, rota.varisNoktasi.ad);
                    if (event && event.effects.fuelConsumptionMultiplier) {
                        tuketimCarpanı *= event.effects.fuelConsumptionMultiplier;
                    }
                }

                return (safeMesafe / 100.0) * 25.0 * Math.max(0.5, tuketimCarpanı); 
            }
            
            getEffectiveSpeed() {
                let finalSpeed = this.hiz;
                const sofor = game.player?.personelListesi?.find(s => s.id === this.atananSoforId);
                if(sofor && sofor.yetenekler && typeof sofor.yetenekler.hizBonusu === 'number'){
                    finalSpeed *= (1 + (sofor.yetenekler.hizBonusu / 100));
                }
                return finalSpeed > 0 ? finalSpeed : 1; 
            }

            sefereBasla(rota) {
                if (!this.atananSoforId && game.player.personelListesi.length > 0) { 
                     game.logMessage(`UYARI: ${this.marka} ${this.model} için şoför atanmamış! Lütfen Garaj'dan atama yapın.`, "warning");
                     return false; 
                }
                this.durum = "yolda";
                this.mevcutRota = rota;
                this.konum = rota.kalkisNoktasi.ad; 
                let rotaStr = `${rota.kalkisNoktasi.ad} -> `;
                if (rota.araDurakNoktasi) rotaStr += `${rota.araDurakNoktasi.ad} -> `;
                rotaStr += rota.varisNoktasi.ad;
                game.logMessage(`${this.marka} ${this.model} (ID: ${this.id}) ${rotaStr} seferine başladı.`);
                
                const sofor = game.player?.personelListesi?.find(s => s.id === this.atananSoforId);
                if(sofor){
                    sofor.durum = "Seferde";
                    sofor.atananOtobusId = this.id;
                }
                return true;
            }

            seferiTamamla() {
                let rotaStr = `${this.mevcutRota.kalkisNoktasi.ad} -> `;
                if (this.mevcutRota.araDurakNoktasi) rotaStr += `${this.mevcutRota.araDurakNoktasi.ad} -> `;
                rotaStr += this.mevcutRota.varisNoktasi.ad;
                game.logMessage(`${this.marka} ${this.model} (ID: ${this.id}) seferi (${rotaStr}) tamamladı: ${this.mevcutRota.varisNoktasi.ad} noktasına ulaştı.`);
                
                this.durum = "garajda";
                if (this.mevcutRota && this.mevcutRota.varisNoktasi) {
                    this.konum = this.mevcutRota.varisNoktasi.ad; 
                }

                const sofor = game.player?.personelListesi?.find(s => s.id === this.atananSoforId);
                if(sofor){
                    sofor.durum = "Boşta"; 
                    sofor.atananOtobusId = null; 
                    sofor.yorgunluk += Math.floor(this.mevcutRota.tahminiSure / 2) + 10; 
                    if (sofor.yorgunluk > 100) sofor.yorgunluk = 100;
                    sofor.deneyimKazan(Math.floor(this.mevcutRota.toplamMesafe / 20));
                }
                this.mevcutRota = null;
            }

            yakitDoldur(miktar) {
                this.yakitSeviyesi += miktar;
                if (this.yakitSeviyesi > this.yakitKapasitesi) {
                    this.yakitSeviyesi = this.yakitKapasitesi; 
                }
                game.logMessage(`${this.marka} ${this.model} (ID: ${this.id}) yakıtı ${this.yakitSeviyesi.toFixed(2)} litreye yükseltildi.`);
            }
        }

        class Route {
            static _rota_id_sayaci = 1;
            constructor(kalkisNoktasi, varisNoktasi, araDurakNoktasi = null, rotaTipi = 'Şehirler Arası') {
                this.id = Route._rota_id_sayaci++;
                this.kalkisNoktasi = kalkisNoktasi;
                this.varisNoktasi = varisNoktasi;
                this.araDurakNoktasi = araDurakNoktasi;
                this.rotaTipi = rotaTipi;
                this.toplamMesafe = 0;
                this.tahminiSure = 0; 
                this.atananOtobus = null;
                this.aktif = false; 
                
                this.pricingConfig = {
                    standardPrice: 0,
                    businessPrice: 0,
                    dynamicPricing: {
                        enabled: false,
                        earlyBirdDiscount: 0.15, // %15 indirim
                        lastMinutePremium: 0.25, // %25 zam
                    }
                };
                this.finalRevenue = 0;
                this.passengerManifest = { standard: 0, business: 0 };

                this.mesafeHesapla(); 
            }

            mesafeHesapla() {
                 if (this.rotaTipi === 'Şehir İçi') {
                    this.toplamMesafe = Math.floor(Math.random() * (40 - 15 + 1)) + 15; // 15-40 km arası
                } else {
                    if (this.araDurakNoktasi) {
                        const mesafeEtap1 = game.mesafeyiBul(this.kalkisNoktasi.ad, this.araDurakNoktasi.ad);
                        const mesafeEtap2 = game.mesafeyiBul(this.araDurakNoktasi.ad, this.varisNoktasi.ad);
                        this.toplamMesafe = mesafeEtap1 + mesafeEtap2;
                    } else {
                        this.toplamMesafe = game.mesafeyiBul(this.kalkisNoktasi.ad, this.varisNoktasi.ad);
                    }
                }
                this.toplamMesafe = (typeof this.toplamMesafe === 'number' && isFinite(this.toplamMesafe)) ? this.toplamMesafe : 0;
            }

            calculatePassengerDemandAndRevenue(otobus, kalkisTarihi) {
                this.atananOtobus = otobus;
                const etkiliHiz = this.rotaTipi === 'Şehir İçi' ? otobus.getEffectiveSpeed() * 0.6 : otobus.getEffectiveSpeed();
                let sureGecikmesiSaat = 0;
                const event = game.getEventForRoute(this.kalkisNoktasi.ad, this.varisNoktasi.ad);
                if (event && event.effects.timePenaltyHours) sureGecikmesiSaat = event.effects.timePenaltyHours;
                if (event && event.effects.routeBlocked) { this.tahminiSure = Infinity; this.finalRevenue = 0; return; }
                
                this.tahminiSure = (this.toplamMesafe / etkiliHiz) + sureGecikmesiSaat;
                if (!isFinite(this.tahminiSure)) this.tahminiSure = 0;

                let { standardPrice, businessPrice } = this.pricingConfig;
                const { enabled, earlyBirdDiscount, lastMinutePremium } = this.pricingConfig.dynamicPricing;
                
                const saatFarki = (kalkisTarihi.getTime() - game.oyunTarihi.getTime()) / (1000 * 3600);

                if (enabled && this.rotaTipi === 'Şehirler Arası') {
                    if (saatFarki > 24 * 7 * 2) { 
                        standardPrice *= (1 - earlyBirdDiscount);
                    } else if (saatFarki < 24) {
                        standardPrice *= (1 + lastMinutePremium);
                        businessPrice *= (1 + lastMinutePremium * 1.5);
                    }
                }

                let totalDemand = otobus.totalCapacity * 1.2 * game.getYolcuTalebiCarpanı(this.varisNoktasi.ad, this.rotaTipi);
                
                const businessDemand = totalDemand * 0.20;
                const familyDemand = totalDemand * 0.30;
                const economyDemand = totalDemand * 0.50;

                let businessYolcu = 0;
                let standardYolcu = 0;

                const getAttraction = (price, basePrice) => {
                    const priceRatio = price / basePrice;
                    if (priceRatio <= 1.6) return 1.0; 
                    if (priceRatio > 2.5) return 0.1; 
                    return 1.0 - (priceRatio - 1.6) / (2.5 - 1.6) * 0.9;
                };
                
                let baseStandardPrice;
                if(this.rotaTipi === 'Şehir İçi'){
                    baseStandardPrice = STANDART_FIYAT_SEHIRICI;
                } else {
                    baseStandardPrice = this.toplamMesafe * STANDART_KM_BASINA_FIYAT_SEHIRLERARASI * 2.0;
                }

                if (otobus.seatConfig.business > 0 && businessPrice > 0) {
                    const baseBusinessPrice = baseStandardPrice * 1.8;
                    const businessAttraction = getAttraction(businessPrice, baseBusinessPrice);
                    businessYolcu = Math.min(otobus.seatConfig.business, Math.floor(businessDemand * businessAttraction * otobus.getMemnuniyetBonusu('business')));
                }
                
                const standardAttraction = getAttraction(standardPrice, baseStandardPrice);
                const remainingBusiness = (businessDemand - businessYolcu) * 0.3; 
                const familyAttracted = familyDemand * standardAttraction * otobus.getMemnuniyetBonusu('standard');
                const economyAttracted = economyDemand * standardAttraction * otobus.getMemnuniyetBonusu('standard');
                
                standardYolcu = Math.min(otobus.seatConfig.standard, Math.floor(remainingBusiness + familyAttracted + economyAttracted));

                this.passengerManifest = { standard: standardYolcu, business: businessYolcu };
                this.finalRevenue = (standardYolcu * standardPrice) + (businessYolcu * businessPrice);
            }
        }

        class Player {
            constructor(ad = "Yeni Kaptan", baslangicPara = 500000) {
                this.ad = ad;
                this.para = baslangicPara;
                this.deneyimPuani = 0;
                this.seviye = 1;
                this.sahipOlunanOtobusler = [];
                this.garajKapasitesi = 3;
                this.seviyeAtlamaXp = { 1: 100, 2: 250, 3: 500, 4: 1000, 5: 2000, 6: 4000, 7: 8000, 8: 15000, 9: 30000, 10: 50000 };
                this.personelListesi = []; 
                this.sirketAdi = null; 
                this.sirketLogosu = "https://placehold.co/100x100/374151/FFFFFF?text=LOGO"; 
                this.erisilebilirOtogarlar = []; 
                this.planlanmisSeferler = [];
                
                this.financialHistory = [];
                this.stats = {
                    totalPassengers: 0,
                    totalKm: 0,
                    routePopularity: {},
                    satisfactionHistory: [],
                    tripCompletionHours: []
                };
            }

            static fromFirestore(data) {
                const player = new Player(data.ad ?? "Yeni Kaptan", data.para ?? 500000);
                player.deneyimPuani = data.deneyimPuani ?? 0;
                player.seviye = data.seviye ?? 1;
                player.garajKapasitesi = data.garajKapasitesi ?? 3;
                player.sirketAdi = data.sirketAdi || null; 
                player.sirketLogosu = data.sirketLogosu || "https://placehold.co/100x100/374151/FFFFFF?text=LOGO"; 
                player.erisilebilirOtogarlar = data.erisilebilirOtogarlar || []; 
                player.planlanmisSeferler = data.planlanmisSeferler_simple || []; 
                player.financialHistory = data.financialHistory || [];
                player.stats = data.stats || { totalPassengers: 0, totalKm: 0, routePopularity: {}, satisfactionHistory: [], tripCompletionHours: [] };

                player.sahipOlunanOtobusler = (data.sahipOlunanOtobusler_simple || []).map(b_simple => {
                    let busData = game.tumOtobusTipleri.find(typeBus => typeBus.marka === b_simple.marka && typeBus.model === b_simple.model);
                     if (!busData) { 
                        busData = { marka: b_simple.marka || "Bilinmeyen", model: b_simple.model || "Model", fiyat: 0, hiz: 70, yakitKapasitesi: 200, yolcuKapasitesi: 30 };
                    }
                    const bus = new Bus(busData.marka, busData.model, busData.fiyat, busData.hiz, busData.yakitKapasitesi, busData.yolcuKapasitesi, false);
                    bus.id = b_simple.id || Bus._otobus_id_sayaci++; 
                    bus.yakitSeviyesi = (typeof b_simple.yakitSeviyesi === 'number' && isFinite(b_simple.yakitSeviyesi)) ? b_simple.yakitSeviyesi : bus.yakitKapasitesi;
                    bus.durum = b_simple.durum ?? "garajda";
                    bus.konum = b_simple.konum ?? (player.erisilebilirOtogarlar.length > 0 ? player.erisilebilirOtogarlar[0] : "Bilinmiyor"); 
                    bus.atananSoforId = b_simple.atananSoforId || null; 
                    bus.donanim = b_simple.donanim || { wifi: false, konfor: false, tv: false };
                    bus.seatConfig = b_simple.seatConfig || { standard: bus.yolcuKapasitesi, business: 0 };
                    return bus;
                }).filter(b => b !== null); 
                Bus._otobus_id_sayaci = player.sahipOlunanOtobusler.length > 0 ? Math.max(1, ...player.sahipOlunanOtobusler.map(b => b.id)) + 1 : 1;

                player.personelListesi = (data.personelListesi_simple || []).map(s_simple => Sofor.fromFirestore(s_simple));
                const maxSoforIdNum = player.personelListesi.length > 0 ? Math.max(0, ...player.personelListesi.map(s => parseInt(s.id.split('_')[1] || 0))) : 0;
                Sofor._sofor_id_sayaci = maxSoforIdNum + 1;

                return player;
            }

            toFirestore() {
                const cleanNumber = (val, defaultVal = 0) => (typeof val === 'number' && isFinite(val)) ? val : defaultVal;

                return {
                    ad: this.ad || "Bilinmeyen Oyuncu",
                    para: cleanNumber(this.para),
                    deneyimPuani: cleanNumber(this.deneyimPuani),
                    seviye: cleanNumber(this.seviye, 1),
                    garajKapasitesi: cleanNumber(this.garajKapasitesi, 3),
                    sirketAdi: this.sirketAdi || null, 
                    sirketLogosu: this.sirketLogosu, 
                    erisilebilirOtogarlar: this.erisilebilirOtogarlar || [],
                    financialHistory: this.financialHistory,
                    stats: this.stats,
                    sahipOlunanOtobusler_simple: this.sahipOlunanOtobusler.map(bus => ({
                        id: bus.id,
                        marka: bus.marka || "Bilinmeyen Marka",
                        model: bus.model || "Bilinmeyen Model",
                        fiyat: cleanNumber(bus.fiyat), 
                        hiz: cleanNumber(bus.hiz),
                        yakitKapasitesi: cleanNumber(bus.yakitKapasitesi),
                        yolcuKapasitesi: cleanNumber(bus.yolcuKapasitesi),
                        yakitSeviyesi: cleanNumber(bus.yakitSeviyesi, bus.yakitKapasitesi),
                        durum: bus.durum || "garajda",
                        konum: bus.konum || (this.erisilebilirOtogarlar.length > 0 ? this.erisilebilirOtogarlar[0] : "Bilinmiyor"),
                        atananSoforId: bus.atananSoforId || null, 
                        donanim: bus.donanim,
                        seatConfig: bus.seatConfig,
                    })),
                    personelListesi_simple: this.personelListesi.map(sofor => sofor.toFirestore()), 
                    aktifSeferlerDetayli_simple: game.aktifSeferlerDetayli
                        .filter(sefer => sefer && sefer.otobus && sefer.rota && sefer.rota.kalkisNoktasi && sefer.rota.varisNoktasi) 
                        .map(sefer => ({
                            otobusId: sefer.otobus.id,
                            rota: { 
                                id: sefer.rota.id, 
                                kalkisNoktasiAd: sefer.rota.kalkisNoktasi.ad,
                                varisNoktasiAd: sefer.rota.varisNoktasi.ad,
                                araDurakNoktasiAd: sefer.rota.araDurakNoktasi ? sefer.rota.araDurakNoktasi.ad : null,
                                rotaTipi: sefer.rota.rotaTipi,
                                toplamMesafe: cleanNumber(sefer.rota.toplamMesafe),
                                finalRevenue: cleanNumber(sefer.rota.finalRevenue),
                                passengerManifest: sefer.rota.passengerManifest
                            },
                            kalanSure: cleanNumber(sefer.kalanSure),
                        })),
                    planlanmisSeferler_simple: this.planlanmisSeferler,
                    oyunTarihi: game.oyunTarihi ? game.oyunTarihi.toISOString() : null,
                    yakitFiyatiLitre: cleanNumber(game.yakitFiyatiLitre, 25.5), 
                    yakitFiyatGecmisi: game.yakitFiyatGecmisi || [],
                    uygunSoforHavuzu_simple: game.uygunSoforHavuzu.map(sofor => sofor.toFirestore()), 
                    activeEvents_simple: game.activeEvents.map(event => ({
                        ...event,
                        expiryDate: event.expiryDate.toISOString(),
                        location: {
                            kalkis: event.location.kalkis ? event.location.kalkis.ad : null,
                            varis: event.location.varis ? event.location.varis.ad : null,
                            sehir: event.location.sehir,
                        }
                    })),
                    lastPlayed: serverTimestamp() 
                };
            }

            gerekliXpHesapla() {
                return this.seviyeAtlamaXp[this.seviye] || 9999999; 
            }

            otobusSatinAl(dukkanOtobusu) { 
                 if (this.para >= dukkanOtobusu.fiyat && this.sahipOlunanOtobusler.length < this.garajKapasitesi) {
                    this.para -= dukkanOtobusu.fiyat;
                    game.recordExpense('assetPurchase', dukkanOtobusu.fiyat);
                    const alinanOtobus = new Bus(dukkanOtobusu.marka, dukkanOtobusu.model, dukkanOtobusu.fiyat,
                                                dukkanOtobusu.hiz, dukkanOtobusu.yakitKapasitesi,
                                                dukkanOtobusu.yolcuKapasitesi, false); 
                    
                    let baslangicOtogari = game.mevcutOtogarlar.find(o => o.ad === this.erisilebilirOtogarlar[0]) || game.mevcutOtogarlar.find(o => o.ad === "AŞTİ") || game.mevcutOtogarlar[0];
                    alinanOtobus.konum = baslangicOtogari.ad;

                    this.sahipOlunanOtobusler.push(alinanOtobus);
                    game.logMessage(`${alinanOtobus.marka} ${alinanOtobus.model} (ID: ${alinanOtobus.id}) başarıyla satın alındı ve ${alinanOtobus.konum}'a yerleştirildi!`);
                    game.savePlayerData(); 
                    return true;
                } else if (this.para < dukkanOtobusu.fiyat) {
                    game.logMessage("Yeterli paranız yok!");
                    return false;
                } else {
                    game.logMessage("Garajınızda yer yok! Önce garajınızı genişletin.");
                    return false;
                }
            }
            
            iseAlSofor(sofor) {
                if (this.para >= sofor.iseAlimUcreti) {
                    this.para -= sofor.iseAlimUcreti;
                    game.recordExpense('recruitment', sofor.iseAlimUcreti);
                    this.personelListesi.push(sofor);
                    game.logMessage(`${sofor.adSoyad} başarıyla işe alındı! İşe Alım Ücreti: ${sofor.iseAlimUcreti.toLocaleString()} TL.`);
                    const index = game.uygunSoforHavuzu.findIndex(s => s.id === sofor.id);
                    if (index > -1) game.uygunSoforHavuzu.splice(index, 1);
                    
                    // Şoför havuzunu kontrol et ve gerekirse yenile
                    if (game.uygunSoforHavuzu.length < 5) {
                        game.addNewSoforlerToPool(5); // 5 yeni şoför ekle
                    } else {
                        game.savePlayerData(); // Her durumda kaydet
                    }

                    game.updateInsanKaynaklariModal(); 
                    game.updateUI(); 
                    return true;
                } else {
                    game.logMessage(`${sofor.adSoyad} için yeterli paranız yok. Gerekli: ${sofor.iseAlimUcreti.toLocaleString()} TL`);
                    return false;
                }
            }

            xpKazan(miktar) {
                this.deneyimPuani += miktar;
                game.logMessage(`${miktar} XP kazanıldı. Toplam XP: ${this.deneyimPuani}`);
                this.seviyeKontrolu();
            }

            seviyeKontrolu() {
                const gerekliXp = this.gerekliXpHesapla();
                if (this.deneyimPuani >= gerekliXp && this.seviye < Object.keys(this.seviyeAtlamaXp).length) { 
                    this.seviye += 1;
                    const seviyeOdulu = this.seviye * 20000; 
                    this.para += seviyeOdulu;
                    game.logMessage(`TEBRİKLER! Seviye ${this.seviye}'ye ulaştınız!`);
                    game.logMessage(`${seviyeOdulu} TL seviye atlama ödülü kazandınız.`);
                    if (this.seviye % 2 == 0) {
                        this.garajKapasitesi += Math.floor(this.seviye / 2);
                        game.logMessage(`Garaj kapasiteniz ${Math.floor(this.seviye / 2)} arttı!`);
                    }
                    game.updateDukkanListesi(); 
                    game.savePlayerData(); 
                }
            }

             garajGenislet(maliyet, artis) {
                if (this.para >= maliyet) {
                    this.para -= maliyet;
                    game.recordExpense('assetPurchase', maliyet);
                    this.garajKapasitesi += artis;
                    game.logMessage(`Garaj kapasitesi ${artis} arttırıldı. Yeni kapasite: ${this.garajKapasitesi}. Maliyet: ${maliyet} TL`);
                    game.savePlayerData(); 
                    return true;
                } else {
                    game.logMessage(`Garaj genişletmek için yeterli para yok. Gerekli: ${maliyet} TL, Mevcut: ${this.para} TL`);
                    return false;
                }
            }

            setSirketAdi(ad) {
                if (!this.sirketAdi && ad && ad.trim() !== "") {
                    this.sirketAdi = ad.trim();
                    game.logMessage(`Şirket adı "${this.sirketAdi}" olarak ayarlandı.`);
                    game.savePlayerData(); 
                    return true;
                } else if (this.sirketAdi) {
                    game.logMessage("Şirket adı zaten ayarlanmış ve değiştirilemez.", "warning");
                    return false;
                } else {
                    game.logMessage("Geçerli bir şirket adı girilmedi.", "warning");
                    return false;
                }
            }

            setSirketLogosu(logoUrl) {
                if (logoUrl && logoUrl.trim() !== "") {
                    this.sirketLogosu = logoUrl.trim();
                    game.logMessage(`Şirket logosu güncellendi.`);
                    game.savePlayerData(); 
                    return true;
                } else {
                    game.logMessage("Geçerli bir logo URL'si girilmedi.", "warning");
                    return false;
                }
            }

            ilkOtogarSec(otogarAdi) {
                const otogar = game.mevcutOtogarlar.find(o => o.ad === otogarAdi);
                if (otogar && this.erisilebilirOtogarlar.length === 0) {
                    otogar.acikMi = true;
                    this.erisilebilirOtogarlar.push(otogar.ad);
                    game.logMessage(`${otogar.ad} başlangıç otogarı olarak ücretsiz seçildi!`);
                    game.savePlayerData();
                    game.updateUI(); 
                    return true;
                }
                game.logMessage("İlk otogar zaten seçilmiş veya otogar bulunamadı.", "warning");
                return false;
            }
    
            otogarAc(otogarAdi) {
                const otogar = game.mevcutOtogarlar.find(o => o.ad === otogarAdi);
                if (!otogar) {
                    game.logMessage("Otogar bulunamadı.", "error"); return false;
                }
                if (otogar.acikMi) {
                    game.logMessage(`${otogar.ad} zaten açık.`, "info"); return false;
                }
                if (this.para >= otogar.acmaUcreti) {
                    this.para -= otogar.acmaUcreti;
                    game.recordExpense('assetPurchase', otogar.acmaUcreti);
                    otogar.acikMi = true;
                    this.erisilebilirOtogarlar.push(otogar.ad);
                    game.logMessage(`${otogar.ad}, ${otogar.acmaUcreti.toLocaleString()} TL karşılığında açıldı!`);
                    game.savePlayerData();
                    game.updateUI(); 
                    if (document.getElementById('modalOtogarYonetimi').classList.contains('flex')) {
                        game.prepareOtogarYonetimiModal(); 
                    }
                    return true;
                } else {
                    game.logMessage(`${otogar.ad} otogarını açmak için yeterli paranız yok. Gerekli: ${otogar.acmaUcreti.toLocaleString()} TL`, "warning");
                    return false;
                }
            }

            aylikGiderleriOde(monthStr) {
                if (!this.personelListesi) return;
                
                let toplamMaas = this.personelListesi.reduce((sum, sofor) => sum + sofor.maas, 0);
                if (toplamMaas > 0) {
                    this.para -= toplamMaas;
                    game.recordExpense('salaries', toplamMaas, monthStr);
                    game.logMessage(`${monthStr} ayı maaşları ödendi: ${toplamMaas.toLocaleString()} TL`, "warning");
                }

                const maintenanceCost = this.sahipOlunanOtobusler.length * 5000;
                if (maintenanceCost > 0) {
                    this.para -= maintenanceCost;
                    game.recordExpense('maintenance', maintenanceCost, monthStr);
                    game.logMessage(`${monthStr} ayı sabit bakım giderleri: ${maintenanceCost.toLocaleString()} TL`, "warning");
                }
                
                game.updateUI();
            }
        }

        const game = {
            player: null,
            mevcutOtogarlar: [],
            istanbulDuraklari: {},
            satilikOtobuslerDukkan: [], 
            tumOtobusTipleri: [], 
            uygunSoforHavuzu: [], 
            aktifSeferlerDetayli: [], 
            activeEvents: [],
            yakitFiyatiLitre: 25.5,
            yakitFiyatGecmisi: [],
            yakitGrafikInstance: null,
            maliRaporGrafikInstance: null,
            rotaYogunlukGrafikInstance: null,
            oyunTarihi: null, 
            activeCountdownIntervals: {}, 
            isAuthReady: false,
            gameLoopInterval: null,
            lastTickTime: null,
            lastEventCheckHour: null,
            mesafeMatrisi: {},
            lastFinancialReportMonth: null,
            fuelPriceUpdateCounter: 0,

            async init() {
                this.setupAuthListeners();
                this.ilkVerileriYukle(); 
                this.setupEventListeners(); 
                this.logMessage("Anatolia Bus Manager'a Hoş Geldiniz! Lütfen giriş yapın veya kayıt olun.");
                this.showAuthUI();
            },
            
            setupAuthListeners() {
                onAuthStateChanged(auth, async (user) => {
                    this.isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userEmailDisplay').textContent = user.email;
                        document.getElementById('btnLogout').classList.remove('hidden');
                        
                        playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/playerData/main`);
                        await this.loadPlayerData(); 
                        this.hideAuthUI();
                        this.logMessage(`${user.email} olarak giriş yapıldı.`);
                        this.startGameLoop();
                    } else {
                        userId = null;
                        playerDocRef = null;
                        if (playerUnsubscribe) playerUnsubscribe();
                        playerUnsubscribe = null;
                        this.player = null; 
                        this.stopGameLoop();
                        
                        document.getElementById('userEmailDisplay').textContent = '';
                        document.getElementById('btnLogout').classList.add('hidden');
                        this.showAuthUI();
                        this.resetGameUI();
                        this.logMessage("Lütfen devam etmek için giriş yapın veya kayıt olun.");
                    }
                    document.getElementById('userIdDisplay').textContent = userId ? `Kullanıcı ID: ${userId}` : 'Giriş Yapılmadı';
                });

                document.getElementById('registerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('registerEmail').value;
                    const password = document.getElementById('registerPassword').value;
                    const authMessage = document.getElementById('authMessage');
                    authMessage.textContent = '';
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        authMessage.textContent = 'Kayıt başarılı! Giriş yapılıyor...';
                        authMessage.className = 'text-green-500 text-sm mt-2';
                    } catch (error) {
                        authMessage.textContent = `Kayıt hatası: ${this.getFirebaseErrorMessage(error.code)}`;
                        authMessage.className = 'text-red-500 text-sm mt-2';
                    }
                });

                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    const authMessage = document.getElementById('authMessage');
                    authMessage.textContent = '';
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        authMessage.textContent = 'Giriş başarılı!';
                        authMessage.className = 'text-green-500 text-sm mt-2';
                    } catch (error) {
                        authMessage.textContent = `Giriş hatası: ${this.getFirebaseErrorMessage(error.code)}`;
                        authMessage.className = 'text-red-500 text-sm mt-2';
                    }
                });

                document.getElementById('btnLogout').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        this.logMessage(`Çıkış hatası: ${error.message}`, "error");
                    }
                });
            },
            
            getFirebaseErrorMessage(errorCode) {
                switch (errorCode) {
                    case 'auth/invalid-email': return 'Geçersiz e-posta adresi.';
                    case 'auth/user-disabled': return 'Bu kullanıcı hesabı devre dışı bırakılmış.';
                    case 'auth/user-not-found': return 'Kullanıcı bulunamadı.';
                    case 'auth/wrong-password': return 'Yanlış şifre.';
                    case 'auth/email-already-in-use': return 'Bu e-posta adresi zaten kayıtlı.';
                    case 'auth/weak-password': return 'Şifre çok zayıf. En az 6 karakter olmalı.';
                    default: return 'Bir kimlik doğrulama hatası oluştu.';
                }
            },

            showAuthUI() {
                document.getElementById('modalAuth').classList.remove('hidden');
                document.getElementById('modalAuth').classList.add('flex');
                document.getElementById('gameContainer').classList.add('hidden');
                document.getElementById('authMessage').textContent = '';
            },

            hideAuthUI() {
                document.getElementById('modalAuth').classList.add('hidden');
                document.getElementById('modalAuth').classList.remove('flex');
                document.getElementById('gameContainer').classList.remove('hidden');
            },
            
            resetGameUI() {
                document.getElementById('playerMoney').textContent = `0 TL`;
                document.getElementById('playerXP').textContent = `0 / 100`;
                document.getElementById('playerLevel').textContent = `1`;
                document.getElementById('oyunTarihi').textContent = `Giriş Yapılmadı`;
                document.getElementById('playerSoforSayisi').textContent = `0`;
                document.getElementById('playerTotalAssets').textContent = `0 TL`;
                document.getElementById('playerBusAssets').textContent = `0 TL (0 otobüs)`;
                document.getElementById('aktifSeferlerList').innerHTML = '<li class="text-gray-400">Giriş yapınız.</li>';
                document.getElementById('planlanmisSeferlerList').innerHTML = '<li class="text-gray-400">Giriş yapınız.</li>';
                document.getElementById('gameLog').innerHTML = '';
                document.getElementById('sirketPaneliBaslik').textContent = "Şirket Paneli";
                document.getElementById('sirketPaneliLogo').classList.add('hidden');
                this.mevcutOtogarlar.forEach(o => o.acikMi = false);
                this.aktifSeferlerDetayli = [];
                this.activeEvents = [];
                this.updateEventsUI();
                this.clearAllCountdownIntervals();
            },
            
            async loadPlayerData() {
                if (!playerDocRef) { 
                    this.player = new Player(auth.currentUser?.email?.split('@')[0] || "Yeni Kaptan"); 
                    this.oyunTarihi = new Date('2025-06-22T08:00:00');
                    this.lastEventCheckHour = this.oyunTarihi.getHours();
                    this.uygunSoforHavuzu = this.generateInitialSoforler(); 
                    this.yakitFiyatGecmisi = [this.yakitFiyatiLitre];
                    this.activeEvents = [];
                    this.lastFinancialReportMonth = `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;
                    this.getOrCreateFinancialRecord(this.lastFinancialReportMonth);
                    if (this.mevcutOtogarlar.length > 0) {
                        this.prepareIlkOtogarSecModal();
                        this.openModal('modalIlkOtogarSec');
                    }
                    this.updateUI(); 
                    this.savePlayerData(true); 
                    return;
                }

                if (playerUnsubscribe) playerUnsubscribe(); 
                
                playerUnsubscribe = onSnapshot(playerDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.player = Player.fromFirestore(data); 
                        this.oyunTarihi = data.oyunTarihi ? new Date(data.oyunTarihi) : new Date('2025-06-22T08:00:00');
                        this.lastEventCheckHour = this.oyunTarihi.getHours();
                        this.yakitFiyatiLitre = data.yakitFiyatiLitre ?? 25.5;
                        this.yakitFiyatGecmisi = data.yakitFiyatGecmisi || [this.yakitFiyatiLitre];
                        this.lastFinancialReportMonth = `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;
                        
                        this.mevcutOtogarlar.forEach(otogar => {
                            otogar.acikMi = this.player.erisilebilirOtogarlar.includes(otogar.ad);
                        });
                        
                        if (data.activeEvents_simple) {
                            this.activeEvents = data.activeEvents_simple.map(e_simple => {
                                const event = { ...e_simple };
                                event.expiryDate = new Date(e_simple.expiryDate);
                                event.location.kalkis = this.mevcutOtogarlar.find(o => o.ad === e_simple.location.kalkis) || null;
                                event.location.varis = this.mevcutOtogarlar.find(o => o.ad === e_simple.location.varis) || null;
                                return event;
                            });
                        } else {
                            this.activeEvents = [];
                        }

                        if (data.uygunSoforHavuzu_simple) {
                            this.uygunSoforHavuzu = data.uygunSoforHavuzu_simple.map(s_simple => Sofor.fromFirestore(s_simple));
                            const maxHavuzSoforIdNum = this.uygunSoforHavuzu.length > 0 ? Math.max(0, ...this.uygunSoforHavuzu.map(s => parseInt(s.id.split('_')[1] || 0))) : 0;
                            const maxPersonelSoforIdNum = this.player.personelListesi.length > 0 ? Math.max(0, ...this.player.personelListesi.map(s => parseInt(s.id.split('_')[1] || 0))) : 0;
                            Sofor._sofor_id_sayaci = Math.max(maxHavuzSoforIdNum, maxPersonelSoforIdNum) + 1;
                        } else if (this.player.personelListesi.length === 0) {
                            this.uygunSoforHavuzu = this.generateInitialSoforler();
                        }
                        
                        this.aktifSeferlerDetayli = []; 
                        if (data.aktifSeferlerDetayli_simple) {
                            this.aktifSeferlerDetayli = data.aktifSeferlerDetayli_simple.map(s_simple => {
                                const otobus = this.player.sahipOlunanOtobusler.find(b => b.id === s_simple.otobusId);
                                
                                let kalkisNoktasi, varisNoktasi, araDurakNoktasi = null;
                                const rotaTipi = s_simple.rota.rotaTipi || 'Şehirler Arası';

                                if(rotaTipi === 'Şehir İçi'){
                                    kalkisNoktasi = { ad: s_simple.rota.kalkisNoktasiAd };
                                    varisNoktasi = { ad: s_simple.rota.varisNoktasiAd };
                                    if(s_simple.rota.araDurakNoktasiAd) araDurakNoktasi = { ad: s_simple.rota.araDurakNoktasiAd };
                                } else {
                                    kalkisNoktasi = this.mevcutOtogarlar.find(o => o.ad === s_simple.rota.kalkisNoktasiAd);
                                    varisNoktasi = this.mevcutOtogarlar.find(o => o.ad === s_simple.rota.varisNoktasiAd);
                                    araDurakNoktasi = s_simple.rota.araDurakNoktasiAd ? this.mevcutOtogarlar.find(o => o.ad === s_simple.rota.araDurakNoktasiAd) : null;
                                }

                                if (otobus && kalkisNoktasi && varisNoktasi && (s_simple.rota.araDurakNoktasiAd ? araDurakNoktasi : true)) { 
                                    const rota = new Route(kalkisNoktasi, varisNoktasi, araDurakNoktasi, rotaTipi);
                                    rota.id = s_simple.rota.id || rota.id; 
                                    rota.finalRevenue = s_simple.rota.finalRevenue || 0;
                                    rota.passengerManifest = s_simple.rota.passengerManifest || { standard: 0, business: 0 };
                                    rota.aktif = true;
                                    otobus.mevcutRota = rota; 
                                    otobus.durum = "yolda";

                                    return {
                                        otobus: otobus,
                                        rota: rota,
                                        kalanSure: s_simple.kalanSure ?? 0,
                                    };
                                }
                                return null; 
                            }).filter(s => s !== null); 
                        }
                        
                        if (this.player.erisilebilirOtogarlar.length === 0 && this.mevcutOtogarlar.length > 0) {
                            this.prepareIlkOtogarSecModal();
                            this.openModal('modalIlkOtogarSec');
                        } else if (!this.player.sirketAdi && !document.getElementById('modalSirketKur').classList.contains('flex') && this.player.erisilebilirOtogarlar.length > 0) {
                            this.openModal('modalSirketKur');
                        }
                    } else {
                        console.log("Kaydedilmiş oyuncu verisi bulunamadı, yeni oyuncu oluşturuluyor.");
                        this.player = new Player(auth.currentUser?.email?.split('@')[0] || "Yeni Kaptan");
                        this.oyunTarihi = new Date('2025-06-22T08:00:00');
                        this.lastEventCheckHour = this.oyunTarihi.getHours();
                        this.yakitFiyatiLitre = 25.5;
                        this.yakitFiyatGecmisi = [this.yakitFiyatiLitre];
                        this.aktifSeferlerDetayli = [];
                        this.activeEvents = [];
                        this.uygunSoforHavuzu = this.generateInitialSoforler(); 
                        this.mevcutOtogarlar.forEach(otogar => otogar.acikMi = false);
                        this.lastFinancialReportMonth = `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;
                        this.getOrCreateFinancialRecord(this.lastFinancialReportMonth);
                        this.savePlayerData(true); 
                        
                        if (this.mevcutOtogarlar.length > 0) {
                            this.prepareIlkOtogarSecModal();
                            this.openModal('modalIlkOtogarSec');
                        }
                    }
                    this.updateUI(); 
                }, (error) => {
                    console.error("Oyuncu verisi dinleme hatası:", error);
                    this.logMessage("Oyuncu verisi yüklenirken hata oluştu.", "error");
                });
            },

            async savePublicCompanyProfile() {
                if (!this.player || !this.player.sirketAdi || !userId) return;

                const publicProfileRef = doc(db, `artifacts/${appId}/public/data/company_profiles/${userId}`);
                const toplamVarlik = this.player.para + this.player.sahipOlunanOtobusler.reduce((sum, bus) => sum + bus.fiyat, 0);

                const profileData = {
                    sirketAdi: this.player.sirketAdi, sirketLogosu: this.player.sirketLogosu,
                    seviye: this.player.seviye, toplamVarlik: toplamVarlik,
                    oyuncuAdi: this.player.ad, oyuncuEposta: auth.currentUser?.email, 
                    userId: userId, lastPlayed: serverTimestamp()
                };
                try {
                    await setDoc(publicProfileRef, profileData, { merge: true }); 
                } catch (error) {
                    console.error("Herkese açık şirket profili kaydetme hatası: ", error);
                }
            },

            async savePlayerData(isNewPlayer = false) {
                if (!playerDocRef || !this.player) return;
                try {
                    const playerData = this.player.toFirestore(); 
                    if (isNewPlayer) {
                        await setDoc(playerDocRef, playerData); 
                    } else {
                        await updateDoc(playerDocRef, playerData); 
                    }
                    await this.savePublicCompanyProfile(); 
                } catch (error) {
                    console.error("Oyuncu verisi kaydetme hatası: ", error);
                    this.logMessage("Oyun kaydedilemedi: " + error.message, "error");
                }
            },
            
            generateRandomSoforler(count) {
                const adlar = ["Ahmet", "Mehmet", "Mustafa", "Ali", "Hüseyin", "Hasan", "İbrahim", "Osman", "Yusuf", "Murat", "Ayşe", "Fatma", "Zeynep", "Emine", "Hatice", "Elif", "Süleyman", "Can", "Burak", "Deniz"];
                const soyadlar = ["Yılmaz", "Kaya", "Demir", "Çelik", "Şahin", "Yıldız", "Arslan", "Koç", "Doğan", "Aydın", "Öztürk", "Çetin", "Kurt", "Polat", "Özdemir", "Can"];
                const havuz = [];
                const playerLevel = this.player ? this.player.seviye : 1;

                for (let i = 0; i < count; i++) {
                    const ad = adlar[Math.floor(Math.random() * adlar.length)];
                    const soyad = soyadlar[Math.floor(Math.random() * soyadlar.length)];
                    const adSoyad = `${ad} ${soyad}`;

                    const deneyim = Math.min(5, Math.floor(Math.random() * (playerLevel + 1)) + 1);
                    const maas = 30000 + (deneyim * 8000) + (playerLevel * 1500) + Math.floor(Math.random() * 10000);
                    const iseAlimUcreti = 50000 + (deneyim * 15000) + (playerLevel * 2500) + Math.floor(Math.random() * 30000);
                    const yetenekler = {
                        yakitTasarrufu: Math.floor(Math.random() * 5) + deneyim,
                        hizBonusu: Math.floor(Math.random() * 3) + Math.floor(deneyim / 2),
                        dayaniklilik: Math.min(10, 5 + deneyim + Math.floor(Math.random() * 3))
                    };
                    havuz.push(new Sofor(adSoyad, deneyim, maas, yetenekler, iseAlimUcreti));
                }
                return havuz;
            },

            addNewSoforlerToPool(count) {
                if (!this.player) return;
                const yeniSoforler = this.generateRandomSoforler(count);
                this.uygunSoforHavuzu.push(...yeniSoforler);
                this.logMessage(`${count} yeni şoför adayı piyasaya katıldı!`, 'success');
                this.savePlayerData();
                if (document.getElementById('modalInsanKaynaklari').classList.contains('flex')) {
                    this.updateInsanKaynaklariModal();
                }
            },

            generateInitialSoforler() {
                Sofor._sofor_id_sayaci = 1; 
                return this.generateRandomSoforler(10);
            },

            ilkVerileriYukle() {
                const otogarVerileri = [
                    ["İstanbul", "Esenler Otogarı", 15000, 250, "https://placehold.co/180x96/EBF4FF/3B82F6?text=Esenler"],
                    ["Ankara", "AŞTİ", 25000, 400, "https://placehold.co/180x96/FAF5FF/9333EA?text=AŞTİ"],
                    ["İzmir", "İZOTAŞ", 20000, 300, "https://placehold.co/180x96/F0FFF4/48BB78?text=İZOTAŞ"],
                    ["İstanbul", "Alibeyköy Cep Otogarı", 8000, 120, "https://placehold.co/180x96/EBF4FF/3B82F6?text=Alibeyköy"],
                    ["Bursa", "Bursa Terminali", 12000, 200, "https://placehold.co/180x96/FEF2F2/EF4444?text=Bursa+Term."],
                    ["Antalya", "Antalya Otogarı", 18000, 280, "https://placehold.co/180x96/FFF7ED/F97316?text=Antalya+Oto."],
                    ["Konya", "Konya Otogarı", 10000, 180, "https://placehold.co/180x96/FAF5FF/9333EA?text=Konya+Oto."],
                    ["Samsun", "Samsun Otogarı", 8500, 140, "https://placehold.co/180x96/EFF6FF/2563EB?text=Samsun+Oto."],
                    ["Trabzon", "Trabzon Otogarı", 7500, 120, "https://placehold.co/180x96/EFF6FF/2563EB?text=Trabzon+Oto."],
                    ["Erzurum", "Erzurum Otogarı", 6000, 90, "https://placehold.co/180x96/F3E8FF/A855F7?text=Erzurum+Oto."],
                    ["Gaziantep", "Gaziantep Otogarı", 9500, 160, "https://placehold.co/180x96/ECFDF5/10B981?text=Gaziantep"],
                    ["Diyarbakır", "DİŞTİ", 8000, 140, "https://placehold.co/180x96/ECFDF5/10B981?text=DİŞTİ"],
                    ["Adana", "Adana Merkez Otogar", 13000, 220, "https://placehold.co/180x96/FFF7ED/F97316?text=Adana"],
                    ["Mersin", "MEŞTİ", 11000, 190, "https://placehold.co/180x96/FFF7ED/F97316?text=Mersin"],
                    ["Kayseri", "Kayseri Terminal", 9000, 170, "https://placehold.co/180x96/FAF5FF/9333EA?text=Kayseri"],
                    ["Eskişehir", "Eskişehir Otogar", 9500, 160, "https://placehold.co/180x96/FEF2F2/EF4444?text=Eskişehir"],
                    ["Denizli", "Denizli Otogar", 8000, 150, "https://placehold.co/180x96/F0FFF4/48BB78?text=Denizli"],
                    ["Malatya", "MAŞTİ", 7000, 130, "https://placehold.co/180x96/F3E8FF/A855F7?text=Malatya"],
                    ["Van", "Van Otogar", 6500, 110, "https://placehold.co/180x96/F3E8FF/A855F7?text=Van"],
                    ["Şanlıurfa", "Şanlıurfa Otogar", 8500, 155, "https://placehold.co/180x96/ECFDF5/10B981?text=Şanlıurfa"],
                    ["Kahramanmaraş", "K.Maraş Otogar", 7200, 125, "https://placehold.co/180x96/ECFDF5/10B981?text=K.Maraş"],
                    ["Sakarya", "Sakarya Terminal", 8800, 165, "https://placehold.co/180x96/FEF2F2/EF4444?text=Sakarya"],
                    ["Muğla", "Muğla Otogar", 9200, 175, "https://placehold.co/180x96/F0FFF4/48BB78?text=Muğla"],
                    ["Tekirdağ", "Tekirdağ Otogar", 6000, 100, "https://placehold.co/180x96/EBF4FF/3B82F6?text=Tekirdağ"],
                    ["Edirne", "Edirne Otogar", 5500, 90, "https://placehold.co/180x96/EBF4FF/3B82F6?text=Edirne"],
                    ["Kırklareli", "Kırklareli Otogar", 4000, 70, "https://placehold.co/180x96/EBF4FF/3B82F6?text=Kırklareli"],
                    ["Çanakkale", "Çanakkale Otogar", 6800, 115, "https://placehold.co/180x96/F0FFF4/48BB78?text=Çanakkale"],
                    ["Balıkesir", "Balıkesir Terminal", 7500, 140, "https://placehold.co/180x96/F0FFF4/48BB78?text=Balıkesir"],
                    ["Manisa", "Manisa Otogar", 7000, 135, "https://placehold.co/180x96/F0FFF4/48BB78?text=Manisa"],
                    ["Aydın", "Aydın Otogar", 7800, 145, "https://placehold.co/180x96/F0FFF4/48BB78?text=Aydın"],
                    ["Uşak", "Uşak Otogar", 5000, 85, "https://placehold.co/180x96/F0FFF4/48BB78?text=Uşak"],
                    ["Kütahya", "Kütahya Otogar", 5200, 95, "https://placehold.co/180x96/FEF2F2/EF4444?text=Kütahya"],
                    ["Afyonkarahisar", "Afyon Otogar", 6300, 110, "https://placehold.co/180x96/FAF5FF/9333EA?text=Afyon"],
                    ["Isparta", "Isparta Otogar", 5800, 105, "https://placehold.co/180x96/FFF7ED/F97316?text=Isparta"],
                    ["Burdur", "Burdur Otogar", 4500, 80, "https://placehold.co/180x96/FFF7ED/F97316?text=Burdur"],
                    ["Zonguldak", "Zonguldak Otogar", 4800, 88, "https://placehold.co/180x96/EFF6FF/2563EB?text=Zonguldak"],
                    ["Bartın", "Bartın Otogar", 3500, 60, "https://placehold.co/180x96/EFF6FF/2563EB?text=Bartın"],
                    ["Karabük", "Karabük Otogar", 4200, 75, "https://placehold.co/180x96/EFF6FF/2563EB?text=Karabük"],
                    ["Kastamonu", "Kastamonu Otogar", 4600, 82, "https://placehold.co/180x96/EFF6FF/2563EB?text=Kastamonu"],
                    ["Sinop", "Sinop Otogar", 3300, 55, "https://placehold.co/180x96/EFF6FF/2563EB?text=Sinop"],
                    ["Çorum", "Çorum Otogar", 5100, 92, "https://placehold.co/180x96/EFF6FF/2563EB?text=Çorum"],
                    ["Amasya", "Amasya Otogar", 4700, 86, "https://placehold.co/180x96/EFF6FF/2563EB?text=Amasya"],
                    ["Tokat", "Tokat Otogar", 5300, 98, "https://placehold.co/180x96/EFF6FF/2563EB?text=Tokat"],
                    ["Sivas", "Sivas Otogar", 6800, 120, "https://placehold.co/180x96/F3E8FF/A855F7?text=Sivas"],
                    ["Yozgat", "Yozgat Otogar", 4300, 78, "https://placehold.co/180x96/FAF5FF/9333EA?text=Yozgat"],
                    ["Kırşehir", "Kırşehir Otogar", 4100, 72, "https://placehold.co/180x96/FAF5FF/9333EA?text=Kırşehir"],
                    ["Nevşehir", "Nevşehir Otogar", 5400, 100, "https://placehold.co/180x96/FAF5FF/9333EA?text=Nevşehir"],
                    ["Aksaray", "Aksaray Otogar", 4900, 89, "https://placehold.co/180x96/FAF5FF/9333EA?text=Aksaray"],
                    ["Niğde", "Niğde Otogar", 4400, 81, "https://placehold.co/180x96/FAF5FF/9333EA?text=Niğde"],
                    ["Karaman", "Karaman Otogar", 4000, 73, "https://placehold.co/180x96/FAF5FF/9333EA?text=Karaman"],
                    ["Erzincan", "Erzincan Otogar", 5700, 102, "https://placehold.co/180x96/F3E8FF/A855F7?text=Erzincan"],
                    ["Bingöl", "Bingöl Otogar", 3800, 65, "https://placehold.co/180x96/F3E8FF/A855F7?text=Bingöl"],
                    ["Muş", "Muş Otogar", 3900, 68, "https://placehold.co/180x96/F3E8FF/A855F7?text=Muş"],
                    ["Batman", "Batman Otogar", 6100, 108, "https://placehold.co/180x96/ECFDF5/10B981?text=Batman"],
                    ["Mardin", "Mardin Otogar", 5600, 103, "https://placehold.co/180x96/ECFDF5/10B981?text=Mardin"],
                ];
                
                this.mevcutOtogarlar = otogarVerileri.map(data => {
                    const ucret = Math.floor(Math.random() * (250000 - 10000 + 1)) + 10000;
                    return new Otogar(data[0], data[1], data[2], data[3], data[4], ucret);
                });

                this.buildDistanceMatrix(); 
                this.loadIstanbulStops();

                const otobusVerileri = [
                    {marka: "Otokar", model: "Sultan City", fiyat: 165000, hiz: 80, yakitKapasitesi: 190, yolcuKapasitesi: 29, seviyeGereksinimi: 1, imageUrl: "images/otokarsultan.png"},
                    {marka: "Isuzu", model: "Novo", fiyat: 175000, hiz: 82, yakitKapasitesi: 180, yolcuKapasitesi: 29, seviyeGereksinimi: 1, imageUrl: "https://placehold.co/120x80/777/fff?text=Isuzu+Novo"},
                    {marka: "Temsa", model: "Prestij SX", fiyat: 185000, hiz: 85, yakitKapasitesi: 200, yolcuKapasitesi: 31, seviyeGereksinimi: 1, imageUrl: "https://placehold.co/120x80/777/fff?text=Prestij+SX"},
                    {marka: "BMC", model: "Procity 10m", fiyat: 210000, hiz: 75, yakitKapasitesi: 220, yolcuKapasitesi: 35, seviyeGereksinimi: 1, imageUrl: "https://placehold.co/120x80/777/fff?text=Procity+10m"},
                    {marka: "Karsan", model: "Atak", fiyat: 195000, hiz: 78, yakitKapasitesi: 210, yolcuKapasitesi: 33, seviyeGereksinimi: 1, imageUrl: "https://placehold.co/120x80/777/fff?text=Karsan+Atak"},
                    {marka: "Mercedes-Benz", model: "Tourismo 15 RHD", fiyat: 350000, hiz: 95, yakitKapasitesi: 350, yolcuKapasitesi: 46, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Tourismo+15"},
                    {marka: "MAN", model: "Lion's Coach", fiyat: 360000, hiz: 96, yakitKapasitesi: 360, yolcuKapasitesi: 48, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Lion's+Coach"},
                    {marka: "Otokar", model: "Territo U", fiyat: 320000, hiz: 90, yakitKapasitesi: 320, yolcuKapasitesi: 55, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Territo+U"},
                    {marka: "Isuzu", model: "Visigo", fiyat: 335000, hiz: 92, yakitKapasitesi: 340, yolcuKapasitesi: 39, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Isuzu+Visigo"},
                    {marka: "Setra", model: "ComfortClass S 515 HD", fiyat: 400000, hiz: 100, yakitKapasitesi: 380, yolcuKapasitesi: 51, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Setra+S515HD"},
                    {marka: "Temsa", model: "Safir Plus", fiyat: 375000, hiz: 98, yakitKapasitesi: 370, yolcuKapasitesi: 50, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Safir+Plus"},
                    {marka: "Scania", model: "Interlink HD", fiyat: 410000, hiz: 102, yakitKapasitesi: 400, yolcuKapasitesi: 53, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Interlink"},
                    {marka: "Mercedes-Benz", model: "Travego 15 SHD", fiyat: 550000, hiz: 110, yakitKapasitesi: 450, yolcuKapasitesi: 50, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Travego+15"},
                    {marka: "Temsa", model: "Maraton", fiyat: 480000, hiz: 108, yakitKapasitesi: 420, yolcuKapasitesi: 48, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Maraton"},
                    {marka: "Neoplan", model: "Tourliner", fiyat: 520000, hiz: 109, yakitKapasitesi: 440, yolcuKapasitesi: 52, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Tourliner"},
                    {marka: "Volvo", model: "9700", fiyat: 580000, hiz: 112, yakitKapasitesi: 480, yolcuKapasitesi: 54, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Volvo+9700"},
                    {marka: "Setra", model: "ComfortClass S 517 HD", fiyat: 565000, hiz: 111, yakitKapasitesi: 460, yolcuKapasitesi: 59, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Setra+S517HD"},
                    {marka: "MAN", model: "Lion's Coach L", fiyat: 540000, hiz: 108, yakitKapasitesi: 470, yolcuKapasitesi: 56, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Lion's+L"},
                    {marka: "Scania", model: "Touring HD", fiyat: 530000, hiz: 110, yakitKapasitesi: 450, yolcuKapasitesi: 50, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Scania+Touring"},
                    {marka: "Isuzu", model: "Grand Toro", fiyat: 450000, hiz: 105, yakitKapasitesi: 400, yolcuKapasitesi: 37, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/555/fff?text=Grand+Toro"},
                    {marka: "Volvo", model: "9900", fiyat: 720000, hiz: 118, yakitKapasitesi: 510, yolcuKapasitesi: 55, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/444/fff?text=Volvo+9900"},
                    {marka: "Setra", model: "TopClass S 516 HDH", fiyat: 750000, hiz: 120, yakitKapasitesi: 520, yolcuKapasitesi: 52, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/444/fff?text=Setra+S516HDH"},
                    {marka: "Mercedes-Benz", model: "Travego 16 SHD", fiyat: 680000, hiz: 115, yakitKapasitesi: 500, yolcuKapasitesi: 54, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/444/fff?text=Travego+16"},
                    {marka: "Temsa", model: "Maraton VIP", fiyat: 650000, hiz: 114, yakitKapasitesi: 480, yolcuKapasitesi: 42, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/444/fff?text=Maraton+VIP"},
                    {marka: "MAN", model: "Lion's Coach Supreme", fiyat: 690000, hiz: 116, yakitKapasitesi: 500, yolcuKapasitesi: 44, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/444/fff?text=Lion's+Supreme"},
                    {marka: "Neoplan", model: "Cityliner", fiyat: 710000, hiz: 117, yakitKapasitesi: 510, yolcuKapasitesi: 48, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/444/fff?text=Cityliner"},
                    {marka: "Setra", model: "TopClass S 531 DT", fiyat: 950000, hiz: 115, yakitKapasitesi: 550, yolcuKapasitesi: 78, seviyeGereksinimi: 5, imageUrl: "https://placehold.co/120x80/333/fff?text=Setra+S531DT"},
                    {marka: "Neoplan", model: "Skyliner", fiyat: 980000, hiz: 118, yakitKapasitesi: 580, yolcuKapasitesi: 80, seviyeGereksinimi: 5, imageUrl: "https://placehold.co/120x80/333/fff?text=Skyliner"},
                    {marka: "MAN", model: "Lion's Coach DD", fiyat: 920000, hiz: 112, yakitKapasitesi: 540, yolcuKapasitesi: 82, seviyeGereksinimi: 5, imageUrl: "https://placehold.co/120x80/333/fff?text=Lion's+DD"},
                    {marka: "Volvo", model: "9700 DD", fiyat: 1050000, hiz: 120, yakitKapasitesi: 600, yolcuKapasitesi: 86, seviyeGereksinimi: 5, imageUrl: "https://placehold.co/120x80/333/fff?text=Volvo+9700DD"},
                    {marka: "Mercedes-Benz", model: "Intouro L", fiyat: 850000, hiz: 110, yakitKapasitesi: 500, yolcuKapasitesi: 63, seviyeGereksinimi: 5, imageUrl: "https://placehold.co/120x80/333/fff?text=Intouro+L"},
                    {marka: "Setra", model: "TopClass S 517 HDH", fiyat: 880000, hiz: 122, yakitKapasitesi: 530, yolcuKapasitesi: 56, seviyeGereksinimi: 5, imageUrl: "https://placehold.co/120x80/333/fff?text=Setra+S517HDH"},
                    {marka: "Neoplan", model: "Starliner", fiyat: 1100000, hiz: 125, yakitKapasitesi: 600, yolcuKapasitesi: 50, seviyeGereksinimi: 6, imageUrl: "https://placehold.co/120x80/222/fff?text=Starliner"},
                    {marka: "Temsa", model: "Diamond VIP", fiyat: 1200000, hiz: 128, yakitKapasitesi: 620, yolcuKapasitesi: 40, seviyeGereksinimi: 6, imageUrl: "https://placehold.co/120x80/222/fff?text=Diamond+VIP"},
                    {marka: "Mercedes-Benz", model: "Future Bus", fiyat: 1500000, hiz: 130, yakitKapasitesi: 650, yolcuKapasitesi: 45, seviyeGereksinimi: 7, imageUrl: "https://placehold.co/120x80/111/fff?text=Future+Bus"},
                    {marka: "Volvo", model: "9900 Exclusive", fiyat: 1350000, hiz: 126, yakitKapasitesi: 610, yolcuKapasitesi: 42, seviyeGereksinimi: 6, imageUrl: "https://placehold.co/120x80/222/fff?text=Volvo+9900+Ex"},
                    {marka: "Setra", model: "TopClass S 519 HDH", fiyat: 1400000, hiz: 124, yakitKapasitesi: 630, yolcuKapasitesi: 60, seviyeGereksinimi: 7, imageUrl: "https://placehold.co/120x80/111/fff?text=Setra+S519HDH"},
                    {marka: "MAN", model: "Lion's Star", fiyat: 1150000, hiz: 123, yakitKapasitesi: 590, yolcuKapasitesi: 48, seviyeGereksinimi: 6, imageUrl: "https://placehold.co/120x80/222/fff?text=Lion's+Star"},
                    {marka: "Otokar", model: "Kent LF", fiyat: 250000, hiz: 70, yakitKapasitesi: 250, yolcuKapasitesi: 90, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/888/fff?text=Kent+LF"},
                    {marka: "BMC", model: "Neocity 8.5m", fiyat: 230000, hiz: 72, yakitKapasitesi: 230, yolcuKapasitesi: 60, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/888/fff?text=Neocity"},
                    {marka: "Isuzu", model: "Citiport 12", fiyat: 260000, hiz: 71, yakitKapasitesi: 260, yolcuKapasitesi: 95, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/888/fff?text=Citiport+12"},
                    {marka: "Mercedes-Benz", model: "Conecto", fiyat: 280000, hiz: 74, yakitKapasitesi: 280, yolcuKapasitesi: 100, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/888/fff?text=Conecto"},
                    {marka: "MAN", model: "Lion's City", fiyat: 290000, hiz: 75, yakitKapasitesi: 290, yolcuKapasitesi: 105, seviyeGereksinimi: 3, imageUrl: "https://placehold.co/120x80/888/fff?text=Lion's+City"},
                    {marka: "Karsan", model: "Jest Electric", fiyat: 350000, hiz: 65, yakitKapasitesi: 150, yolcuKapasitesi: 22, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/888/fff?text=Jest+EV"},
                    {marka: "Temsa", model: "Avenue Electron", fiyat: 420000, hiz: 68, yakitKapasitesi: 200, yolcuKapasitesi: 85, seviyeGereksinimi: 4, imageUrl: "https://placehold.co/120x80/888/fff?text=Avenue+EV"},
                    {marka: "Otokar", model: "Sultan Mega", fiyat: 200000, hiz: 88, yakitKapasitesi: 210, yolcuKapasitesi: 35, seviyeGereksinimi: 1, imageUrl: "https://placehold.co/120x80/777/fff?text=Sultan+Mega"},
                    {marka: "Isuzu", model: "Turquoise", fiyat: 215000, hiz: 90, yakitKapasitesi: 220, yolcuKapasitesi: 33, seviyeGereksinimi: 1, imageUrl: "https://placehold.co/120x80/777/fff?text=Turquoise"},
                    {marka: "MAN", model: "TGE Intercity", fiyat: 240000, hiz: 92, yakitKapasitesi: 240, yolcuKapasitesi: 22, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=MAN+TGE"},
                    {marka: "Mercedes-Benz", model: "Sprinter Travel", fiyat: 255000, hiz: 95, yakitKapasitesi: 250, yolcuKapasitesi: 21, seviyeGereksinimi: 2, imageUrl: "https://placehold.co/120x80/666/fff?text=Sprinter+Travel"},
                ];
                this.tumOtobusTipleri = otobusVerileri.map(data => new Bus(data.marka, data.model, data.fiyat, data.hiz, data.yakitKapasitesi, data.yolcuKapasitesi, true, data.imageUrl, data.seviyeGereksinimi)); 
            },

            loadIstanbulStops() {
                const durakData = {
                    "Adalar": ["Büyükada", "Heybeliada"], "Arnavutköy": ["Arnavutköy Merkez", "Bolluca"], "Ataşehir": ["Ataşehir Finans Merkezi", "Batı Ataşehir"],
                    "Avcılar": ["Avcılar Metrobüs", "İÜ Kampüsü"], "Bağcılar": ["Bağcılar Meydan", "Güneşli"], "Bahçelievler": ["Yenibosna Metro", "Şirinevler Meydan"],
                    "Bakırköy": ["Bakırköy Meydan", "Florya Akvaryum"], "Başakşehir": ["Başakşehir Metrokent", "Kayaşehir"], "Bayrampaşa": ["Otogar (Bayrampaşa)", "Axis AVM"],
                    "Beşiktaş": ["Beşiktaş İskele", "Levent Metro"], "Beykoz": ["Beykoz Korusu", "Kavacık"], "Beylikdüzü": ["Beylikdüzü Metrobüs", "Marmara Park AVM"],
                    "Beyoğlu": ["Taksim Meydanı", "Karaköy İskele"], "Büyükçekmece": ["Büyükçekmece Sahil", "TÜYAP"], "Çatalca": ["Çatalca Merkez", "Subaşı"],
                    "Çekmeköy": ["Çekmeköy Metro", "Taşdelen"], "Esenler": ["Esenler Dörtyol", "Atışalanı"], "Esenyurt": ["Esenyurt Meydan", "Haramidere"],
                    "Eyüpsultan": ["Eyüp Sultan Camii", "Göktürk"], "Fatih": ["Aksaray Metro", "Sultanahmet Meydanı"], "Gaziosmanpaşa": ["Gaziosmanpaşa Meydan", "Küçükköy"],
                    "Güngören": ["Güngören Tramvay", "Merter"], "Kadıköy": ["Kadıköy İskele", "Bostancı İskele"], "Kağıthane": ["4. Levent Metro", "Çağlayan Adliyesi"],
                    "Kartal": ["Kartal Metro", "Soğanlık"], "Küçükçekmece": ["Sefaköy Metrobüs", "Halkalı Marmaray"], "Maltepe": ["Maltepe Park AVM", "İdealtepe"],
                    "Pendik": ["Pendik Marmaray", "Kurtköy (Viaport)"], "Sancaktepe": ["Sancaktepe Metro", "Sarıgazi"], "Sarıyer": ["Sarıyer Merkez", "İstinye Park"],
                    "Silivri": ["Silivri Sahil", "Silivri Cezaevi"], "Sultanbeyli": ["Sultanbeyli Merkez", "Plato AVM"], "Sultangazi": ["Sultangazi Merkez", "Cebeci"],
                    "Şile": ["Şile Merkez", "Ağva"], "Şişli": ["Mecidiyeköy Metrobüs", "Nişantaşı"], "Tuzla": ["Tuzla Marina", "İçmeler"],
                    "Ümraniye": ["Ümraniye Çarşı", "Dudullu"], "Üsküdar": ["Üsküdar İskele", "Çamlıca Tepesi"], "Zeytinburnu": ["Zeytinburnu Marmaray", "Merter Tekstil Merkezi"]
                };
                this.istanbulDuraklari = {};
                for (const ilce in durakData) {
                    this.istanbulDuraklari[ilce] = durakData[ilce].map(durakAdi => new Durak(ilce, durakAdi));
                }
            },

            buildDistanceMatrix() {
                const distances = {
                    "Esenler Otogarı-AŞTİ": 450, "Esenler Otogarı-İZOTAŞ": 480, "Esenler Otogarı-Bursa Terminali": 155, "Esenler Otogarı-Antalya Otogarı": 725,
                    "AŞTİ-İZOTAŞ": 590, "AŞTİ-Konya Otogarı": 260, "AŞTİ-Samsun Otogarı": 420, "AŞTİ-Erzurum Otogarı": 880, "AŞTİ-Adana Merkez Otogar": 500,
                    "İZOTAŞ-Antalya Otogarı": 460, "İZOTAŞ-Denizli Otogar": 240, "İZOTAŞ-Muğla Otogar": 215,
                    "Gaziantep Otogarı-DİŞTİ": 150, "Gaziantep Otogarı-Şanlıurfa Otogar": 145,
                    "Trabzon Otogarı-Erzurum Otogarı": 320, "Samsun Otogarı-Trabzon Otogarı": 325,
                };
                this.mesafeMatrisi = {};
                for (const [key, value] of Object.entries(distances)) {
                    const [o1, o2] = key.split('-');
                    this.mesafeMatrisi[`${o1}-${o2}`] = value;
                    this.mesafeMatrisi[`${o2}-${o1}`] = value;
                }
            },
            
            mesafeyiBul(otogarAd1, otogarAd2) {
                if (otogarAd1 === otogarAd2) return 0;
                const key1 = `${otogarAd1}-${otogarAd2}`;
                if (this.mesafeMatrisi[key1]) {
                    return this.mesafeMatrisi[key1];
                }
                return Math.floor(Math.random() * (1200 - 100 + 1)) + 100;
            },
            
            formatKalanSureForDisplay(totalSeconds) {
                if (totalSeconds < 0) totalSeconds = 0;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const pad = (num) => String(num).padStart(2, '0');
                return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            },

            clearAllCountdownIntervals() {
                Object.values(this.activeCountdownIntervals).forEach(clearInterval);
                this.activeCountdownIntervals = {};
            },

            startCountdownForItem(itemId, totalSeconds, varisNoktasiAd) {
                if (this.activeCountdownIntervals[itemId]) clearInterval(this.activeCountdownIntervals[itemId]);
                let remainingSeconds = Math.floor(totalSeconds);
                const countdownElement = document.getElementById('countdown-' + itemId);
                if (!countdownElement) return;
                if (remainingSeconds <= 0) {
                    countdownElement.textContent = `${varisNoktasiAd} Ulaşıldı!`;
                    return;
                }
                countdownElement.textContent = this.formatKalanSureForDisplay(remainingSeconds);
                this.activeCountdownIntervals[itemId] = setInterval(() => {
                    remainingSeconds--;
                    if (countdownElement) countdownElement.textContent = this.formatKalanSureForDisplay(remainingSeconds);
                    if (remainingSeconds <= 0) {
                        clearInterval(this.activeCountdownIntervals[itemId]);
                        delete this.activeCountdownIntervals[itemId];
                        if (countdownElement) countdownElement.textContent = `${varisNoktasiAd} Ulaşıldı!`; 
                    }
                }, 1000);
            },
            
            updateInsanKaynaklariModal() {
                const modalList = document.getElementById('insanKaynaklariListesi');
                if (!modalList || !this.uygunSoforHavuzu || !this.player) return; 
                modalList.innerHTML = ''; 
                if (this.uygunSoforHavuzu.length === 0) {
                    modalList.innerHTML = '<p class="text-gray-400 text-center col-span-full">Uygun şoför adayı yok.</p>';
                    return;
                }
                this.uygunSoforHavuzu.forEach(sofor => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-4 rounded-lg shadow flex flex-col items-center text-center';
                    div.innerHTML = `
                        <img src="${sofor.imageUrl}" alt="${sofor.adSoyad}" class="w-20 h-20 rounded-full mb-3 border-2 border-gray-500 object-cover">
                        <h4 class="text-lg font-semibold text-white">${sofor.adSoyad}</h4>
                        <p class="text-sm text-gray-300">Deneyim: Seviye ${sofor.deneyimSeviyesi}</p>
                        <p class="text-sm text-gray-300">Maaş: ${sofor.maas.toLocaleString()} TL (Aylık)</p>
                        <p class="text-md font-semibold text-yellow-400 mt-1">İşe Alım: ${sofor.iseAlimUcreti.toLocaleString()} TL</p>
                        <button data-sofor-id="${sofor.id}" class="hire-sofor-btn mt-3 bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded text-sm font-semibold w-full">İşe Al</button>`;
                    modalList.appendChild(div);
                });
                document.querySelectorAll('.hire-sofor-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        if (!this.player) return; 
                        const soforId = event.target.dataset.soforId;
                        const secilenSofor = this.uygunSoforHavuzu.find(s => s.id === soforId);
                        if (secilenSofor && this.player) this.player.iseAlSofor(secilenSofor);
                    }, {once: true});
                });
            },

            updateUI() {
                if (!this.player || !this.isAuthReady) { 
                    this.resetGameUI(); 
                    return;
                }
                document.getElementById('playerMoney').textContent = `${this.player.para.toLocaleString()} TL`;
                document.getElementById('playerXP').textContent = `${this.player.deneyimPuani} / ${this.player.gerekliXpHesapla()}`;
                document.getElementById('playerLevel').textContent = this.player.seviye;
                document.getElementById('oyunTarihi').textContent = formatGameDate(this.oyunTarihi);
                document.getElementById('yakitFiyati').textContent = this.yakitFiyatiLitre.toFixed(2);
                document.getElementById('playerSoforSayisi').textContent = this.player.personelListesi.length; 

                const toplamVarlik = this.player.para + this.player.sahipOlunanOtobusler.reduce((sum, bus) => sum + bus.fiyat, 0);
                document.getElementById('playerTotalAssets').textContent = `${toplamVarlik.toLocaleString()} TL`;
                document.getElementById('playerBusAssets').textContent = `${this.player.sahipOlunanOtobusler.reduce((sum, bus) => sum + bus.fiyat, 0).toLocaleString()} TL (${this.player.sahipOlunanOtobusler.length} otobüs)`;
                
                const aktifSeferlerList = document.getElementById('aktifSeferlerList');
                aktifSeferlerList.innerHTML = ''; 
                this.clearAllCountdownIntervals(); 

                if (this.aktifSeferlerDetayli.length === 0) {
                    aktifSeferlerList.innerHTML = '<li class="text-gray-400">Aktif sefer bulunmuyor.</li>';
                } else {
                    this.aktifSeferlerDetayli.forEach(sefer => {
                         if (!sefer.otobus || !sefer.rota || !sefer.rota.kalkisNoktasi || !sefer.rota.varisNoktasi) return; 
                        const li = document.createElement('li');
                        li.className = 'text-sm p-2 bg-gray-700 rounded mb-1 flex justify-between items-center gap-2';
                        let rotaGosterim = `${sefer.rota.kalkisNoktasi.ad} → ${sefer.rota.araDurakNoktasi ? `${sefer.rota.araDurakNoktasi.ad} → ` : ''}${sefer.rota.varisNoktasi.ad}`;
                        const sofor = this.player.personelListesi.find(s => s.id === sefer.otobus.atananSoforId);
                        li.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold text-white">${sefer.otobus.marka} ${sefer.otobus.model} (ID: ${sefer.otobus.id})</p>
                                <p class="text-xs text-gray-400">${rotaGosterim} ${sefer.rota.rotaTipi === 'Şehir İçi' ? '<span class="text-cyan-400">(Şehir İçi)</span>' : ''}</p>
                                ${sofor ? `<p class="text-xs text-indigo-300">Şoför: ${sofor.adSoyad}</p>` : ''}
                            </div>
                            <div class="flex flex-col items-end text-xs">
                                <p class="text-gray-300 whitespace-nowrap">Yakıt: ${sefer.otobus.yakitSeviyesi.toFixed(1)}L</p>
                                <span id="countdown-${sefer.otobus.id}" class="font-mono text-amber-400 whitespace-nowrap"></span>
                            </div>`;
                        aktifSeferlerList.appendChild(li);
                        const kalanSureSaniye = Math.max(0, sefer.kalanSure) * 3600; 
                        this.startCountdownForItem(sefer.otobus.id, kalanSureSaniye, sefer.rota.varisNoktasi.ad);
                    });
                }
                
                const planlanmisSeferlerList = document.getElementById('planlanmisSeferlerList');
                planlanmisSeferlerList.innerHTML = '';
                if (this.player.planlanmisSeferler.length === 0) {
                    planlanmisSeferlerList.innerHTML = '<li class="text-gray-400">Planlanmış sefer bulunmuyor.</li>';
                } else {
                    this.player.planlanmisSeferler.forEach((sefer, index) => {
                        const otobus = this.player.sahipOlunanOtobusler.find(b => b.id === sefer.otobusId);
                        if (!otobus) return;
                        const li = document.createElement('li');
                        li.className = 'text-sm p-2 bg-gray-700 rounded mb-1 flex justify-between items-center gap-2';
                        const planTarihi = new Date(sefer.planlananTarih);
                        li.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold text-white">${otobus.marka} ${otobus.model} (ID: ${otobus.id})</p>
                                <p class="text-xs text-gray-400">${sefer.rota.kalkisAd} → ${sefer.rota.araDurakAd ? `${sefer.rota.araDurakAd} → ` : ''}${sefer.rota.varisAd} ${sefer.rotaTipi === 'Şehir İçi' ? '<span class="text-cyan-400">(Şehir İçi)</span>' : ''}</p>
                            </div>
                            <div class="flex flex-col items-end text-xs">
                                <p class="text-amber-400 whitespace-nowrap">${formatGameDate(planTarihi)}</p>
                                <button data-sefer-index="${index}" class="cancel-planned-trip-btn bg-red-600 hover:bg-red-700 text-white px-2 py-0.5 rounded text-xs mt-1">İptal</button>
                            </div>`;
                        planlanmisSeferlerList.appendChild(li);
                    });

                    document.querySelectorAll('.cancel-planned-trip-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.seferIndex);
                            const sefer = this.player.planlanmisSeferler[index];
                            if(sefer) {
                                this.player.planlanmisSeferler.splice(index, 1);
                                this.logMessage(`Planlanmış sefer (Otobüs ID: ${sefer.otobusId}) iptal edildi.`);
                                this.updateUI();
                                this.savePlayerData();
                            }
                        }, {once: true});
                    });
                }


                this.updateDukkanListesi();
                this.updateGarajListesi();
                this.updateSirketPaneliUI();
                this.updateEventsUI();
                if (document.getElementById('modalOtogarYonetimi').classList.contains('flex')) {
                    this.prepareOtogarYonetimiModal();
                }
            },

            updateSirketPaneliUI() {
                if (!this.player) return;
                const sirketPaneliBaslik = document.getElementById('sirketPaneliBaslik');
                const sirketPaneliLogo = document.getElementById('sirketPaneliLogo'); 
                const sirketAdiGoruntule = document.getElementById('sirketAdiGoruntule');
                const sirketLogosuGoruntule = document.getElementById('sirketLogosuGoruntule');
                
                if (this.player.sirketAdi) {
                    if(sirketPaneliBaslik) sirketPaneliBaslik.textContent = this.player.sirketAdi; 
                    if(sirketPaneliLogo) { 
                        sirketPaneliLogo.src = this.player.sirketLogosu;
                        sirketPaneliLogo.classList.remove('hidden');
                    }
                    if(sirketAdiGoruntule) sirketAdiGoruntule.textContent = this.player.sirketAdi;
                    if(sirketLogosuGoruntule) sirketLogosuGoruntule.src = this.player.sirketLogosu;
                    document.getElementById('btnSirketim').classList.remove('hidden'); 
                } else {
                     if(sirketPaneliBaslik) sirketPaneliBaslik.textContent = "Şirket Paneli"; 
                     if(sirketPaneliLogo) sirketPaneliLogo.classList.add('hidden'); 
                     document.getElementById('btnSirketim').classList.add('hidden'); 
                }
            },
            
            updateEventsUI() {
                const eventsList = document.getElementById('activeEventsList');
                if (!eventsList) return;
                
                eventsList.innerHTML = '';
                if (this.activeEvents.length === 0) {
                    eventsList.innerHTML = '<li class="text-gray-400 italic">Şu anda önemli bir olay yok.</li>';
                    return;
                }

                this.activeEvents.forEach(event => {
                    const li = document.createElement('li');
                    let colorClass = 'text-yellow-300';
                    let icon = '🚧';
                    if (event.type === 'FESTIVAL') {
                        colorClass = 'text-green-400';
                        icon = '🎉';
                    } else if (event.type === 'ACCIDENT') {
                        colorClass = 'text-red-400';
                        icon = '💥';
                    }

                    const kalanSureMs = event.expiryDate.getTime() - (this.oyunTarihi?.getTime() || Date.now());
                    const kalanGun = Math.max(0, Math.ceil(kalanSureMs / (1000 * 60 * 60 * 24)));
                    
                    li.className = `text-sm p-2 bg-gray-700 rounded mb-1`;
                    li.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="${colorClass} font-semibold">${icon} ${event.description}</p>
                            <p class="text-xs text-gray-400 whitespace-nowrap">${kalanGun > 0 ? `${kalanGun} gün kaldı` : 'Bitiyor'}</p>
                        </div>
                    `;
                    eventsList.appendChild(li);
                });
            },

            updateDukkanListesi() {
                if (!this.player) return;
                const dukkanListesi = document.getElementById('dukkanOtobusListesi');
                dukkanListesi.innerHTML = ''; 
                this.satilikOtobuslerDukkan = this.tumOtobusTipleri.filter(otobus => this.player.seviye >= otobus.seviyeGereksinimi);
                if (this.satilikOtobuslerDukkan.length === 0) {
                    dukkanListesi.innerHTML = '<p class="text-gray-400 text-center">Satın alabileceğiniz otobüs yok.</p>';
                } else {
                    this.satilikOtobuslerDukkan.forEach((otobus, index) => { 
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-700 rounded mb-3 flex flex-col sm:flex-row justify-between items-center gap-3';
                        div.innerHTML = `
                            <div class="flex items-center gap-3 flex-grow">
                                <img src="${otobus.imageUrl || 'https://placehold.co/100x60/374151/FFFFFF?text=Görsel+Yok'}" alt="${otobus.marka}" class="w-24 h-16 object-cover rounded border border-gray-600">
                                <div>
                                    <h4 class="font-semibold text-md">${otobus.marka} ${otobus.model}</h4>
                                    <p class="text-xs text-gray-300">Fiyat: ${otobus.fiyat.toLocaleString()} TL | Hız: ${otobus.hiz} km/s | Yolcu: ${otobus.yolcuKapasitesi}</p>
                                    <p class="text-xs text-gray-400">Gerekli Seviye: ${otobus.seviyeGereksinimi}</p>
                                </div>
                            </div>
                            <button data-bus-index="${index}" class="buy-bus-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-semibold w-full sm:w-auto">Satın Al</button>`;
                        dukkanListesi.appendChild(div);
                    });
                }
                document.querySelectorAll('.buy-bus-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        if (!this.player) return;
                        if (this.player.erisilebilirOtogarlar.length === 0) {
                            this.logMessage("Önce başlangıç otogarınızı seçmelisiniz!", "warning");
                            this.prepareIlkOtogarSecModal();
                            this.openModal('modalIlkOtogarSec');
                            return;
                        }
                        const busIndex = parseInt(event.target.dataset.busIndex);
                        const secilenOtobus = this.satilikOtobuslerDukkan[busIndex];
                        if (secilenOtobus) this.player.otobusSatinAl(secilenOtobus);
                    }, {once: true});
                });
            },
            
            updateGarajListesi() {
                if (!this.player) return;
                const garajOtobusListesi = document.getElementById('garajOtobusListesi');
                const personelDurumu = document.getElementById('personelDurumu');
                garajOtobusListesi.innerHTML = '';
                personelDurumu.innerHTML = '';
                document.getElementById('garajKapasite').textContent = `${this.player.sahipOlunanOtobusler.length} / ${this.player.garajKapasitesi}`;

                if (this.player.sahipOlunanOtobusler.length === 0) {
                    garajOtobusListesi.innerHTML = '<p class="text-gray-400 col-span-full">Garajınızda otobüs yok.</p>';
                } else {
                    this.player.sahipOlunanOtobusler.forEach(otobus => {
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-600 rounded mb-2';
                        const atananSofor = this.player.personelListesi.find(s => s.id === otobus.atananSoforId);
                        
                        const donanimlarHTML = `
                            <div class="mt-2 pt-2 border-t border-gray-500 text-xs">
                                <p class="font-semibold mb-1">Donanımlar:</p>
                                <div class="flex flex-wrap gap-2 items-center">
                                    ${otobus.donanim.wifi ? '<span class="text-green-400">✓ Wi-Fi</span>' : `<button data-bus-id="${otobus.id}" data-donanim="wifi" class="upgrade-bus-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">Wi-Fi (${otobus.donanimMaliyetleri.wifi.toLocaleString()} TL)</button>`}
                                    ${otobus.donanim.konfor ? '<span class="text-green-400">✓ Konfor</span>' : `<button data-bus-id="${otobus.id}" data-donanim="konfor" class="upgrade-bus-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">Konfor (${otobus.donanimMaliyetleri.konfor.toLocaleString()} TL)</button>`}
                                    ${otobus.donanim.tv ? '<span class="text-green-400">✓ TV</span>' : `<button data-bus-id="${otobus.id}" data-donanim="tv" class="upgrade-bus-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">TV (${otobus.donanimMaliyetleri.tv.toLocaleString()} TL)</button>`}
                                </div>
                            </div>
                        `;

                        div.innerHTML = `
                            <div class="flex justify-between items-start gap-2">
                                <div>
                                    <h4 class="font-semibold">${otobus.marka} ${otobus.model} (ID: ${otobus.id})</h4>
                                    <p class="text-xs">Durum: ${otobus.durum}, Konum: ${otobus.konum || 'Bilinmiyor'}</p>
                                    <p class="text-xs">Yakıt: ${otobus.yakitSeviyesi.toFixed(1)} / ${otobus.yakitKapasitesi.toFixed(1)} L</p>
                                    <p class="text-xs sofor-bilgisi-${otobus.id}">Şoför: ${atananSofor ? `${atananSofor.adSoyad} (%${atananSofor.yorgunluk} yorgun)` : 'Yok'}</p>
                                    <p class="text-xs font-medium text-amber-300">Koltuklar: ${otobus.seatConfig.standard} Standart, ${otobus.seatConfig.business} Business</p>
                                </div>
                                <div class="flex flex-col gap-2 flex-shrink-0">
                                    <button data-bus-id="${otobus.id}" class="assign-sofor-btn bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded text-xs">Ata</button>
                                    <button data-bus-id="${otobus.id}" class="modify-bus-btn bg-teal-500 hover:bg-teal-600 text-white px-2 py-1 rounded text-xs">Modifiye</button>
                                </div>
                            </div>
                            ${donanimlarHTML}
                        `;
                        garajOtobusListesi.appendChild(div);
                    });
                }
                
                personelDurumu.innerHTML = '<h4 class="text-lg font-semibold mb-2 col-span-full border-t border-gray-500 pt-3 mt-3">Personel (Şoförler)</h4>';
                if (this.player.personelListesi.length === 0) {
                    personelDurumu.innerHTML += '<p class="text-gray-400 col-span-full">Henüz şoförünüz yok.</p>';
                } else {
                    this.player.personelListesi.forEach(sofor => {
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-600 rounded mb-2';
                        const atandigiOtobus = this.player.sahipOlunanOtobusler.find(o => o.id === sofor.atananOtobusId);
                        div.innerHTML = `
                            <h5 class="font-semibold">${sofor.adSoyad} (Seviye ${sofor.deneyimSeviyesi})</h5>
                            <p class="text-xs">Maaş: ${sofor.maas.toLocaleString()} TL</p>
                            <p class="text-xs">Durum: ${sofor.durum}, Yorgunluk: ${sofor.yorgunluk}%</p>
                            <p class="text-xs">Atandığı Otobüs: ${atandigiOtobus ? `${atandigiOtobus.marka} ${atandigiOtobus.model}` : 'Boşta'}</p>
                            ${sofor.durum === "Boşta" && sofor.yorgunluk > 0 ? `<button data-sofor-id="${sofor.id}" class="dinlendir-sofor-btn bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs mt-1">Dinlendir (%${sofor.yorgunluk})</button>` : ''}`;
                        personelDurumu.appendChild(div);
                    });
                }
                document.querySelectorAll('.assign-sofor-btn').forEach(btn => btn.addEventListener('click', e => this.openSoforAtamaModal(parseInt(e.target.dataset.busId))));
                document.querySelectorAll('.modify-bus-btn').forEach(btn => btn.addEventListener('click', e => this.prepareBusModifyModal(parseInt(e.target.dataset.busId))));
                document.querySelectorAll('.dinlendir-sofor-btn').forEach(btn => btn.addEventListener('click', e => this.dinlendirSofor(e.target.dataset.soforId)));
                document.querySelectorAll('.upgrade-bus-btn').forEach(btn => btn.addEventListener('click', e => {
                    const busId = parseInt(e.target.dataset.busId);
                    const donanimTipi = e.target.dataset.donanim;
                    const otobus = this.player.sahipOlunanOtobusler.find(b => b.id === busId);
                    if (otobus) otobus.yukselt(donanimTipi);
                }));
            },
            
            dinlendirSofor(soforId) {
                if (!this.player) return;
                const sofor = this.player.personelListesi.find(s => s.id === soforId);
                if (sofor && sofor.durum === "Boşta" && sofor.yorgunluk > 0) {
                    sofor.yorgunluk = Math.max(0, sofor.yorgunluk - 25); 
                    this.logMessage(`${sofor.adSoyad} dinlendirildi. Yeni yorgunluk: ${sofor.yorgunluk}%`);
                    this.updateGarajListesi(); 
                    this.savePlayerData();
                }
            },

            openSoforAtamaModal(busId) {
                if (!this.player) return;
                const secilenOtobus = this.player.sahipOlunanOtobusler.find(b => b.id === busId);
                if (!secilenOtobus) return;
                const select = document.getElementById('soforAtaSelect');
                select.innerHTML = '<option value="">Şoför Seçin</option>';
                this.player.personelListesi.filter(s => s.durum === "Boşta" && s.yorgunluk < 70 || s.id === secilenOtobus.atananSoforId).forEach(sofor => {
                    const option = document.createElement('option');
                    option.value = sofor.id;
                    option.textContent = `${sofor.adSoyad} (Yorgunluk: ${sofor.yorgunluk}%)`;
                    if (sofor.id === secilenOtobus.atananSoforId) option.selected = true;
                    select.appendChild(option);
                });
                if (secilenOtobus.atananSoforId) select.innerHTML += '<option value="CIKAR">--- Şoförü Çıkar ---</option>';
                document.getElementById('soforAtaBusId').value = busId;
                this.openModal('modalSoforAta');
            },

            logMessage(message, type = "info") { 
                const logArea = document.getElementById('gameLog');
                if (!logArea) return; 
                const p = document.createElement('p');
                p.textContent = `[${new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})}] ${message}`;
                p.className = `text-sm ${type === "error" ? 'text-red-400' : type === "warning" ? 'text-yellow-400' : type === "success" ? 'text-green-400' : 'text-gray-300'}`;
                logArea.insertBefore(p, logArea.firstChild);
                if(logArea.children.length > 50) {
                    logArea.removeChild(logArea.lastChild);
                }
            },

            setupEventListeners() {
                const addClickListener = (id, callback) => {
                    const button = document.getElementById(id);
                    if (button) button.addEventListener('click', () => {
                        if (this.player) callback();
                        else this.logMessage("Lütfen önce giriş yapın.", "warning");
                    });
                };
                
                addClickListener('btnDukkan', () => this.openModal('modalDukkan'));
                addClickListener('btnGaraj', () => { this.updateGarajListesi(); this.openModal('modalGaraj'); });
                addClickListener('btnSirketim', () => { this.prepareSirketimModal(); this.openModal('modalSirketBilgileri'); });
                addClickListener('btnOtogarYonetimi', () => { this.prepareOtogarYonetimiModal(); this.openModal('modalOtogarYonetimi'); });
                addClickListener('btnInsanKaynaklari', () => { this.updateInsanKaynaklariModal(); this.openModal('modalInsanKaynaklari'); });
                addClickListener('btnDigerSirketler', () => { this.prepareDigerSirketlerModal(); this.openModal('modalDigerSirketler'); });
                addClickListener('btnYeniAdayAra', () => {
                    if (!this.player) return;
                    const cost = 10000;
                    if (this.player.para >= cost) {
                        this.player.para -= cost;
                        this.recordExpense('recruitment', cost);
                        this.logMessage(`${cost.toLocaleString()} TL karşılığında yeni şoför adayları arandı.`, 'info');
                        this.addNewSoforlerToPool(3);
                    } else {
                        this.logMessage(`Yeni aday aramak için yeterli para yok. Gerekli: ${cost.toLocaleString()} TL`, 'warning');
                    }
                });
                
                const checkPrerequisites = (callback) => {
                    if (!this.player) { this.logMessage("Lütfen önce giriş yapın.", "warning"); return; }
                    if (this.player.erisilebilirOtogarlar.length === 0) {
                        this.logMessage("Önce başlangıç otogarınızı seçmelisiniz!", "warning");
                        this.prepareIlkOtogarSecModal();
                        this.openModal('modalIlkOtogarSec');
                    } else {
                        callback();
                    }
                };

                addClickListener('btnRota', () => checkPrerequisites(() => { this.prepareRotaModal(); this.openModal('modalRota'); }));
                addClickListener('btnYakit', () => checkPrerequisites(() => { this.prepareYakitModal(); this.openModal('modalYakit'); }));
                
                document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => this.closeModal(btn.closest('.modal').id)));
                
                document.getElementById('btnGarajGenislet').addEventListener('click', () => {
                    if (!this.player) return;
                    const maliyet = 150000 + (this.player.garajKapasitesi - 3) * 75000; 
                    this.player.garajGenislet(maliyet, 1); 
                    this.updateGarajListesi(); 
                });
                
                document.getElementById('btnSoforAtaOnayla').addEventListener('click', () => {
                    if (!this.player) return;
                    const busId = parseInt(document.getElementById('soforAtaBusId').value);
                    const soforId = document.getElementById('soforAtaSelect').value;
                    const otobus = this.player.sahipOlunanOtobusler.find(b => b.id === busId);
                    if (!otobus) return;

                    const eskiSofor = this.player.personelListesi.find(s => s.id === otobus.atananSoforId);
                    if (eskiSofor) {
                        eskiSofor.durum = "Boşta";
                        eskiSofor.atananOtobusId = null;
                    }
                    otobus.atananSoforId = null; 
                    
                    if (soforId && soforId !== "CIKAR") {
                        const yeniSofor = this.player.personelListesi.find(s => s.id === soforId);
                        if (yeniSofor && yeniSofor.durum === "Boşta") {
                            otobus.atananSoforId = yeniSofor.id;
                            yeniSofor.durum = "Atandı"; 
                            yeniSofor.atananOtobusId = otobus.id;
                        }
                    }
                    this.updateGarajListesi();
                    this.savePlayerData();
                    this.closeModal('modalSoforAta');
                });

                document.getElementById('btnSirketKurOnayla').addEventListener('click', () => {
                    if (!this.player) return;
                    const sirketAdi = document.getElementById('sirketAdiKurInput').value;
                    const sirketLogosu = document.getElementById('sirketLogosuKurInput').value;
                    if (this.player.setSirketAdi(sirketAdi)) {
                        this.player.setSirketLogosu(sirketLogosu); 
                        this.updateSirketPaneliUI();
                        this.closeModal('modalSirketKur');
                    }
                });

                document.getElementById('btnSirketLogoGuncelle').addEventListener('click', () => {
                    if (!this.player) return;
                    const yeniLogoUrl = document.getElementById('sirketLogosuInput').value;
                    this.player.setSirketLogosu(yeniLogoUrl);
                    this.updateSirketPaneliUI();
                });

                this.setupRotaModalActions(); 
                this.setupYakitModalActions(); 

                document.getElementById('showRegister').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('registerForm').classList.remove('hidden');
                    document.getElementById('authModalTitle').textContent = 'Kayıt Ol';
                    document.getElementById('authMessage').textContent = '';
                });
                document.getElementById('showLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('authModalTitle').textContent = 'Giriş Yap';
                    document.getElementById('authMessage').textContent = '';
                });

                const sirketModal = document.getElementById('modalSirketBilgileri');
                if (sirketModal) {
                    sirketModal.addEventListener('click', (e) => {
                        if (e.target.closest('.tab-btn')) {
                            const targetBtn = e.target.closest('.tab-btn');
                            sirketModal.querySelectorAll('.tab-btn').forEach(btn => {
                                btn.classList.remove('border-indigo-500', 'text-indigo-400');
                                btn.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');
                            });
                            targetBtn.classList.add('border-indigo-500', 'text-indigo-400');
                            targetBtn.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');

                            sirketModal.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                            
                            if (targetBtn.id === 'tabBtnGenel') document.getElementById('tabContentGenel').classList.remove('hidden');
                            else if (targetBtn.id === 'tabBtnMali') document.getElementById('tabContentMali').classList.remove('hidden');
                            else if (targetBtn.id === 'tabBtnOperasyonel') document.getElementById('tabContentOperasyonel').classList.remove('hidden');
                            else if (targetBtn.id === 'tabBtnRotaAnalizi') {
                                document.getElementById('tabContentRotaAnalizi').classList.remove('hidden');
                                this.renderRotaAnalizi();
                            }
                        }
                    });
                }
            },
            
            prepareRotaModal() {
                if (!this.player || !this.oyunTarihi) return;
                const rotaTipiSelect = document.getElementById('rotaTipiSec');
                const sehirlerArasiContainer = document.getElementById('sehirlerArasiContainer');
                const sehirIciContainer = document.getElementById('sehirIciContainer');
                
                const rotaOtobusSelect = document.getElementById('rotaOtobusSec');
                const rotaTarihSaatInput = document.getElementById('rotaTarihSaatInput');

                const simdi = new Date(this.oyunTarihi);
                simdi.setHours(simdi.getHours() + 1); 
                const yyyy = simdi.getFullYear();
                const mm = String(simdi.getMonth() + 1).padStart(2, '0');
                const dd = String(simdi.getDate()).padStart(2, '0');
                const HH = String(simdi.getHours()).padStart(2, '0');
                const MM = String(simdi.getMinutes()).padStart(2, '0');
                rotaTarihSaatInput.min = `${yyyy}-${mm}-${dd}T${HH}:${MM}`;
                rotaTarihSaatInput.value = `${yyyy}-${mm}-${dd}T${HH}:${MM}`;

                rotaOtobusSelect.innerHTML = '<option value="">Otobüs Seçin</option>';
                this.player.sahipOlunanOtobusler.forEach(bus => {
                    const option = document.createElement('option');
                    option.value = bus.id;
                    let durumEtiketi = bus.durum === 'garajda' ? `Garajda (${bus.konum})` : 'Seferde';
                    option.textContent = `${bus.marka} ${bus.model} (ID: ${bus.id}) [${durumEtiketi}]`;
                    rotaOtobusSelect.appendChild(option);
                });
                
                const handleRotaTipiChange = () => {
                    if (rotaTipiSelect.value === 'Şehir İçi') {
                        sehirlerArasiContainer.classList.add('hidden');
                        sehirIciContainer.classList.remove('hidden');
                        this.populateSehirIciRotaSelectors();
                    } else {
                        sehirIciContainer.classList.add('hidden');
                        sehirlerArasiContainer.classList.remove('hidden');
                        this.populateSehirlerArasiRotaSelectors();
                    }
                    this.updateRotaOzeti();
                }

                rotaTipiSelect.removeEventListener('change', handleRotaTipiChange);
                rotaTipiSelect.addEventListener('change', handleRotaTipiChange);
                handleRotaTipiChange(); 
                
                const allRotaInputs = [
                    rotaOtobusSelect, document.getElementById('rotaKalkisSec'), document.getElementById('rotaAraDurakSec'), document.getElementById('rotaVarisSec'),
                    document.getElementById('rotaKalkisIlceSec'), document.getElementById('rotaKalkisDurakSec'), document.getElementById('rotaVarisIlceSec'), document.getElementById('rotaVarisDurakSec'),
                    document.getElementById('rotaAraDurakEkleCheckbox'), document.getElementById('rotaTarihSaatInput'),
                    document.getElementById('rotaStandardPrice'), document.getElementById('rotaBusinessPrice'),
                    document.getElementById('dynamicPricingToggle')
                ];

                allRotaInputs.forEach(el => {
                    el.removeEventListener('change', this.updateRotaOzetiListener);
                    el.removeEventListener('input', this.updateRotaOzetiListener);
                    const eventType = el.tagName === 'INPUT' && (el.type === 'number' || el.type === 'datetime-local') ? 'input' : 'change';
                    el.addEventListener(eventType, this.updateRotaOzetiListener);
                });

                this.updateRotaOzeti(); 
            },
            
            populateSehirlerArasiRotaSelectors() {
                const rotaKalkisSelect = document.getElementById('rotaKalkisSec');
                const rotaAraDurakSelect = document.getElementById('rotaAraDurakSec'); 
                const rotaVarisSelect = document.getElementById('rotaVarisSec');
                const araDurakCheckbox = document.getElementById('rotaAraDurakEkleCheckbox'); 
                const araDurakContainer = document.getElementById('rotaAraDurakContainer');
                
                araDurakCheckbox.checked = false; 
                araDurakContainer.classList.add('hidden'); 

                araDurakCheckbox.onchange = () => { 
                    araDurakContainer.classList.toggle('hidden', !araDurakCheckbox.checked);
                    if (!araDurakCheckbox.checked) rotaAraDurakSelect.value = ""; 
                    this.updateRotaOzeti(); 
                };

                const acikOtogarlar = this.mevcutOtogarlar.filter(o => o.acikMi);
                [rotaKalkisSelect, rotaAraDurakSelect, rotaVarisSelect].forEach(select => {
                    const currentVal = select.value;
                    select.innerHTML = `<option value="">${select.id.includes('Kalkis') ? 'Kalkış' : (select.id.includes('Varis') ? 'Varış' : 'Ara Durak')} Otogarı Seçin</option>`;
                    acikOtogarlar.forEach(otogar => {
                        select.innerHTML += `<option value="${otogar.ad}">${otogar.toString()}</option>`;
                    });
                    select.value = currentVal;
                });
            },
            
            populateSehirIciRotaSelectors() {
                const ilceler = Object.keys(this.istanbulDuraklari);
                const kalkisIlceSelect = document.getElementById('rotaKalkisIlceSec');
                const varisIlceSelect = document.getElementById('rotaVarisIlceSec');

                [kalkisIlceSelect, varisIlceSelect].forEach(select => {
                    const currentVal = select.value;
                    select.innerHTML = '<option value="">İlçe Seçin</option>';
                    ilceler.forEach(ilce => {
                        select.innerHTML += `<option value="${ilce}">${ilce}</option>`;
                    });
                    select.value = currentVal;
                });
                
                const handleIlceChange = (ilceSelect, durakSelect) => {
                    const secilenIlce = ilceSelect.value;
                    durakSelect.innerHTML = '<option value="">Durak Seçin</option>';
                    if(secilenIlce && this.istanbulDuraklari[secilenIlce]) {
                        this.istanbulDuraklari[secilenIlce].forEach(durak => {
                            durakSelect.innerHTML += `<option value="${durak.ad}">${durak.ad}</option>`;
                        });
                    }
                };

                kalkisIlceSelect.onchange = () => handleIlceChange(kalkisIlceSelect, document.getElementById('rotaKalkisDurakSec'));
                varisIlceSelect.onchange = () => handleIlceChange(varisIlceSelect, document.getElementById('rotaVarisDurakSec'));
                
                handleIlceChange(kalkisIlceSelect, document.getElementById('rotaKalkisDurakSec'));
                handleIlceChange(varisIlceSelect, document.getElementById('rotaVarisDurakSec'));
            },

            updateRotaOzetiListener: function() { if(game.player) game.updateRotaOzeti(); }, 

            setupRotaModalActions() {
                document.getElementById('btnRotaHemenBaslat').addEventListener('click', () => this.rotaBaslat(false));
                document.getElementById('btnRotaPlanla').addEventListener('click', () => this.rotaBaslat(true));
            },

            rotaBaslat(isPlanned) {
                if (!this.player) return;

                const rotaTipi = document.getElementById('rotaTipiSec').value;
                const otobusId = parseInt(document.getElementById('rotaOtobusSec').value);
                const planlananTarih = document.getElementById('rotaTarihSaatInput').value;
                
                const secilenOtobus = this.player.sahipOlunanOtobusler.find(b => b.id === otobusId);
                if (!secilenOtobus) { this.logMessage("Lütfen geçerli bir otobüs seçin.", "warning"); return; }
                
                if (!isPlanned && secilenOtobus.durum !== 'garajda') {
                    this.logMessage(`${secilenOtobus.marka} ${secilenOtobus.model} şu anda seferde olduğu için hemen yeni bir sefere başlayamaz. Lütfen seferi planlayın veya otobüsün garaja dönmesini bekleyin.`, "error");
                    return;
                }
                
                let kalkisNoktasi, varisNoktasi, araDurakNoktasi = null;
                let kalkisAd, varisAd, araDurakAd = null;

                if(rotaTipi === 'Şehir İçi'){
                    kalkisAd = document.getElementById('rotaKalkisDurakSec').value;
                    varisAd = document.getElementById('rotaVarisDurakSec').value;
                    if (!kalkisAd || !varisAd) { this.logMessage("Lütfen şehir içi için kalkış ve varış duraklarını seçin.", "warning"); return; }
                    kalkisNoktasi = new Durak(document.getElementById('rotaKalkisIlceSec').value, kalkisAd);
                    varisNoktasi = new Durak(document.getElementById('rotaVarisIlceSec').value, varisAd);
                } else {
                    kalkisAd = document.getElementById('rotaKalkisSec').value;
                    varisAd = document.getElementById('rotaVarisSec').value;
                    araDurakAd = document.getElementById('rotaAraDurakEkleCheckbox').checked ? document.getElementById('rotaAraDurakSec').value : null;
                    kalkisNoktasi = this.mevcutOtogarlar.find(o => o.ad === kalkisAd);
                    varisNoktasi = this.mevcutOtogarlar.find(o => o.ad === varisAd);
                    araDurakNoktasi = araDurakAd ? this.mevcutOtogarlar.find(o => o.ad === araDurakAd) : null;
                    if (!kalkisNoktasi || !varisNoktasi || (araDurakAd && !araDurakNoktasi)) { this.logMessage("Lütfen geçerli bir rota seçin.", "warning"); return; }
                }

                const yeniRota = new Route(kalkisNoktasi, varisNoktasi, araDurakNoktasi, rotaTipi); 
                yeniRota.pricingConfig.standardPrice = parseFloat(document.getElementById('rotaStandardPrice').value) || 0;
                yeniRota.pricingConfig.businessPrice = parseFloat(document.getElementById('rotaBusinessPrice').value) || 0;
                yeniRota.pricingConfig.dynamicPricing.enabled = document.getElementById('dynamicPricingToggle').checked;

                const event = this.getEventForRoute(kalkisAd, varisAd);
                if (event && event.effects.routeBlocked) {
                    this.logMessage(`Bu rota (${event.description}) nedeniyle geçici olarak kapalı!`, "error"); return;
                }

                if (kalkisAd === varisAd || (araDurakAd && (kalkisAd === araDurakAd || varisAd === araDurakAd))) {
                    this.logMessage("Kalkış, varış ve ara durak farklı olmalıdır.", "warning"); return;
                }
                if (rotaTipi === 'Şehirler Arası' && (!kalkisNoktasi.acikMi || !varisNoktasi.acikMi || (araDurakNoktasi && !araDurakNoktasi.acikMi))) {
                    this.logMessage("Seçilen otogarlardan biri erişilebilir değil.", "warning"); return;
                }
                const sofor = this.player.personelListesi.find(s => s.id === secilenOtobus.atananSoforId);
                if (this.player.personelListesi.length > 0 && (!sofor || sofor.yorgunluk >= 70)) {
                    this.logMessage(`Şoför atanmamış veya çok yorgun. Rota başlatılamadı.`, "warning"); return;
                }
                
                const gerekliYakit = secilenOtobus.yakitTuketimiHesapla(yeniRota.toplamMesafe, yeniRota);
                if (secilenOtobus.yakitSeviyesi < gerekliYakit) {
                    this.logMessage(`Yakıt yetersiz (${secilenOtobus.yakitSeviyesi.toFixed(1)}L / ${gerekliYakit.toFixed(1)}L gerekli).`, "warning"); return;
                }
                
                const planZamani = new Date(planlananTarih);
                if (isPlanned) {
                    if (isNaN(planZamani) || planZamani <= this.oyunTarihi) {
                        this.logMessage("Lütfen gelecek için geçerli bir tarih ve saat girin.", "warning"); return;
                    }
                    const planlanmisSefer = {
                        id: `plan_${Date.now()}_${Math.random()}`,
                        otobusId: secilenOtobus.id,
                        rota: { kalkisAd, varisAd, araDurakAd },
                        rotaTipi: rotaTipi,
                        pricingConfig: yeniRota.pricingConfig,
                        planlananTarih: planZamani.toISOString()
                    };
                    this.player.planlanmisSeferler.push(planlanmisSefer);
                    this.logMessage(`${secilenOtobus.marka} için ${formatGameDate(planZamani)} tarihine sefer planlandı.`);
                } else {
                    yeniRota.calculatePassengerDemandAndRevenue(secilenOtobus, planZamani);
                    if (secilenOtobus.sefereBasla(yeniRota)) { 
                        yeniRota.aktif = true;
                        this.aktifSeferlerDetayli.push({
                            otobus: secilenOtobus, rota: yeniRota,
                            kalanSure: yeniRota.tahminiSure
                        });
                        this.logMessage(`${secilenOtobus.marka} rotaya hemen başladı! Tahmini Gelir: ${yeniRota.finalRevenue.toLocaleString()} TL.`);
                    }
                }
                this.closeModal('modalRota');
                this.savePlayerData();
                this.updateUI();
            },
            
            updateRotaOzeti() {
                if (!this.player) return; 
                const rotaTipi = document.getElementById('rotaTipiSec').value;
                const rotaOtobusSelect = document.getElementById('rotaOtobusSec');
                const rotaOzetiDiv = document.getElementById('rotaOzeti');
                const rotaOlayUyarisiDiv = document.getElementById('rotaOlayUyarisi');
                const standardPriceInput = document.getElementById('rotaStandardPrice');
                const businessPriceInput = document.getElementById('rotaBusinessPrice');
                const businessPriceContainer = document.getElementById('businessPriceContainer');
                const dynamicPricingToggle = document.getElementById('dynamicPricingToggle');
                const rotaTarihSaatInput = document.getElementById('rotaTarihSaatInput');

                const otobusId = parseInt(rotaOtobusSelect.value);
                
                rotaOlayUyarisiDiv.innerHTML = '';
                rotaOlayUyarisiDiv.classList.add('hidden');
                
                const secilenOtobus = this.player.sahipOlunanOtobusler.find(b => b.id === otobusId);
                
                if (secilenOtobus && secilenOtobus.seatConfig.business > 0) {
                    businessPriceContainer.classList.remove('hidden');
                } else {
                    businessPriceContainer.classList.add('hidden');
                    businessPriceInput.value = '';
                }
                
                let kalkisNoktasi, varisNoktasi, araDurakNoktasi;
                if(rotaTipi === 'Şehir İçi'){
                    const kalkisAd = document.getElementById('rotaKalkisDurakSec').value;
                    const varisAd = document.getElementById('rotaVarisDurakSec').value;
                    if (!kalkisAd || !varisAd) { rotaOzetiDiv.innerHTML = '<p class="text-sm text-gray-400">Rota detayları için durakları seçin.</p>'; return; }
                    kalkisNoktasi = new Durak(document.getElementById('rotaKalkisIlceSec').value, kalkisAd);
                    varisNoktasi = new Durak(document.getElementById('rotaVarisIlceSec').value, varisAd);
                } else {
                    const kalkisAd = document.getElementById('rotaKalkisSec').value;
                    const varisAd = document.getElementById('rotaVarisSec').value;
                    const araDurakAd = document.getElementById('rotaAraDurakEkleCheckbox').checked ? document.getElementById('rotaAraDurakSec').value : null;
                    if (!kalkisAd || !varisAd || (araDurakAd && !araDurakAd)) { rotaOzetiDiv.innerHTML = '<p class="text-sm text-gray-400">Rota detayları için otogarları seçin.</p>'; return; }
                    kalkisNoktasi = this.mevcutOtogarlar.find(o => o.ad === kalkisAd);
                    varisNoktasi = this.mevcutOtogarlar.find(o => o.ad === varisAd);
                    araDurakNoktasi = araDurakAd ? this.mevcutOtogarlar.find(o => o.ad === araDurakAd) : null;
                }

                if (!otobusId || !kalkisNoktasi || !varisNoktasi) {
                    rotaOzetiDiv.innerHTML = '<p class="text-sm text-gray-400">Rota detayları için tüm seçimleri yapın.</p>'; return;
                }
                
                const tempRota = new Route(kalkisNoktasi, varisNoktasi, araDurakNoktasi, rotaTipi); 
                const fiyatCarpanı = secilenOtobus.getFiyatArtisCarpanı();

                let minPrice;
                if(rotaTipi === 'Şehir İçi'){
                     minPrice = Math.floor(STANDART_FIYAT_SEHIRICI * fiyatCarpanı);
                } else {
                     minPrice = Math.floor(tempRota.toplamMesafe * STANDART_KM_BASINA_FIYAT_SEHIRLERARASI * fiyatCarpanı);
                }
                const optimalPrice = Math.floor(minPrice * 1.5);
                const priceSuggestionHTML = `<p class="text-xs text-center text-cyan-300 mt-1">Öneri: ${minPrice.toLocaleString()} TL - ${optimalPrice.toLocaleString()} TL</p>`;

                if (parseFloat(standardPriceInput.value) < minPrice || standardPriceInput.value === '') {
                    standardPriceInput.value = minPrice;
                }
                
                if (secilenOtobus.seatConfig.business > 0) {
                    const minBusinessPrice = Math.floor(minPrice * 1.8);
                    if (parseFloat(businessPriceInput.value) < minBusinessPrice || businessPriceInput.value === '') {
                        businessPriceInput.value = minBusinessPrice;
                    }
                }
                
                tempRota.pricingConfig.standardPrice = parseFloat(standardPriceInput.value);
                tempRota.pricingConfig.businessPrice = secilenOtobus.seatConfig.business > 0 ? parseFloat(businessPriceInput.value) : 0;
                tempRota.pricingConfig.dynamicPricing.enabled = dynamicPricingToggle.checked;
                const planZamani = new Date(rotaTarihSaatInput.value);

                tempRota.calculatePassengerDemandAndRevenue(secilenOtobus, planZamani);
                const gerekliYakit = secilenOtobus.yakitTuketimiHesapla(tempRota.toplamMesafe, tempRota);

                const event = this.getEventForRoute(kalkisNoktasi.ad, varisNoktasi.ad);
                if(event) {
                    let colorClass = 'bg-yellow-900 text-yellow-300';
                    if (event.type === 'FESTIVAL') colorClass = 'bg-green-900 text-green-300';
                    else if (event.type === 'ACCIDENT') colorClass = 'bg-red-900 text-red-300';
                    
                    rotaOlayUyarisiDiv.innerHTML = `<p class="text-xs p-2 rounded ${colorClass}">${event.description}</p>`;
                    rotaOlayUyarisiDiv.classList.remove('hidden');
                }

                if (tempRota.tahminiSure === Infinity) {
                    rotaOzetiDiv.innerHTML = `<p class="text-sm text-red-400 font-bold">BU ROTA GEÇİCİ OLARAK KAPALI!</p>`;
                } else {
                    rotaOzetiDiv.innerHTML = `
                        <p class="text-sm"><b>Mesafe:</b> ${tempRota.toplamMesafe} km | <b>Tahmini Süre:</b> ${tempRota.tahminiSure.toFixed(2)} saat</p>
                        <p class="text-sm"><b>Gerekli Yakıt:</b> ${gerekliYakit.toFixed(2)} L (Mevcut: ${secilenOtobus.yakitSeviyesi.toFixed(2)} L)</p>
                        <p class="text-sm text-cyan-400"><b>Tahmini Yolcu:</b> ${tempRota.passengerManifest.standard} Standart, ${tempRota.passengerManifest.business} Business</p>
                        <p class="text-lg font-bold text-green-400"><b>Tahmini Gelir:</b> ${tempRota.finalRevenue.toLocaleString()} TL</p>
                        ${priceSuggestionHTML}
                    `;
                }
            },

            prepareYakitModal() {
                if (!this.player) return;
                const yakitOtobusSelect = document.getElementById('yakitOtobusSec');
                document.getElementById('modalYakitFiyati').textContent = this.yakitFiyatiLitre.toFixed(2);
                yakitOtobusSelect.innerHTML = '<option value="">Otobüs Seçin</option>';
                this.player.sahipOlunanOtobusler.filter(b => b.durum === 'garajda' && this.mevcutOtogarlar.find(o=>o.ad === b.konum)?.acikMi).forEach(bus => {
                    yakitOtobusSelect.innerHTML += `<option value="${bus.id}">${bus.marka} ${bus.model} (Yakıt: ${bus.yakitSeviyesi.toFixed(1)}L / ${bus.yakitKapasitesi.toFixed(1)}L)</option>`;
                });
                document.getElementById('yakitMiktar').value = ''; 
                this.renderYakitGrafigi();
            },

            setupYakitModalActions() {
                document.getElementById('btnYakitAl').addEventListener('click', () => { if(this.player) this.yakitAlIslemi(parseFloat(document.getElementById('yakitMiktar').value)); });
                document.getElementById('btnYakitTamDoldur').addEventListener('click', () => { if(this.player) this.yakitAlIslemi('tam'); }); 
            },

            yakitAlIslemi(miktar) { 
                if (!this.player) return;
                const otobusId = parseInt(document.getElementById('yakitOtobusSec').value);
                const secilenOtobus = this.player.sahipOlunanOtobusler.find(b => b.id === otobusId);
                if (!secilenOtobus) { this.logMessage("Lütfen bir otobüs seçin.", "warning"); return; }
                
                let alinacakMiktar = (miktar === 'tam') ? secilenOtobus.yakitKapasitesi - secilenOtobus.yakitSeviyesi : miktar;
                if (isNaN(alinacakMiktar) || alinacakMiktar <= 0) { this.logMessage("Geçerli bir miktar girin.", "warning"); return; }
                
                alinacakMiktar = Math.min(alinacakMiktar, secilenOtobus.yakitKapasitesi - secilenOtobus.yakitSeviyesi);
                if (alinacakMiktar < 0.01) { this.logMessage("Depo zaten dolu.", "info"); return; }

                const maliyet = alinacakMiktar * this.yakitFiyatiLitre;
                if (this.player.para >= maliyet) {
                    this.player.para -= maliyet;
                    secilenOtobus.yakitDoldur(alinacakMiktar);
                    this.recordExpense('fuel', maliyet);
                    this.logMessage(`${alinacakMiktar.toFixed(2)} L yakıt alındı. Maliyet: ${maliyet.toFixed(2)} TL.`);
                    this.closeModal('modalYakit');
                    game.savePlayerData(); 
                } else {
                    this.logMessage(`Yeterli para yok. Gerekli: ${maliyet.toFixed(2)} TL.`, "warning");
                }
            },

            openModal(modalId) { document.getElementById(modalId)?.classList.remove('hidden'); document.getElementById(modalId)?.classList.add('flex'); },
            closeModal(modalId) { document.getElementById(modalId)?.classList.add('hidden'); document.getElementById(modalId)?.classList.remove('flex'); },

            prepareIlkOtogarSecModal() {
                if (!this.player) return;
                const liste = document.getElementById('ilkOtogarSecListesi');
                liste.innerHTML = '';
                this.mevcutOtogarlar.slice(0, 3).forEach(otogar => { 
                    liste.innerHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow flex flex-col items-center text-center">
                            <img src="${otogar.imageUrl}" alt="${otogar.ad}" class="w-full h-32 object-cover rounded-md mb-2">
                            <h4 class="text-lg font-semibold text-white">${otogar.ad}</h4>
                            <p class="text-sm text-gray-300">${otogar.sehir}</p>
                            <button data-otogar-ad="${otogar.ad}" class="select-ilk-otogar-btn mt-3 bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded text-sm font-semibold w-full">Seç (Ücretsiz)</button>
                        </div>`;
                });
                document.querySelectorAll('.select-ilk-otogar-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        if (!this.player) return;
                        if (this.player.ilkOtogarSec(event.target.dataset.otogarAd)) {
                            this.closeModal('modalIlkOtogarSec');
                            if (!this.player.sirketAdi) this.openModal('modalSirketKur');
                        }
                    }, {once: true});
                });
            },

            prepareOtogarYonetimiModal() {
                if (!this.player) return;
                const liste = document.getElementById('otogarYonetimiListesi');
                liste.innerHTML = '';
                this.mevcutOtogarlar.forEach(otogar => {
                    const buttonHtml = otogar.acikMi ? '<p class="text-sm text-green-400 mt-auto text-center font-semibold py-2">Açık</p>' : `<button data-otogar-ad="${otogar.ad}" class="unlock-otogar-btn mt-auto bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold w-full">Aç (${otogar.acmaUcreti.toLocaleString()} TL)</button>`;
                    liste.innerHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow flex flex-col">
                            <img src="${otogar.imageUrl}" alt="${otogar.ad}" class="w-full h-32 object-cover rounded-md mb-2">
                            <h4 class="text-md font-semibold text-white">${otogar.ad}</h4>
                            <p class="text-xs text-gray-300">${otogar.sehir}</p>
                            ${buttonHtml}
                        </div>`;
                });
                document.querySelectorAll('.unlock-otogar-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        if (this.player) this.player.otogarAc(event.target.dataset.otogarAd);
                    }, {once: true});
                });
            },
            
            prepareBusModifyModal(busId) {
                if (!this.player) return;
                const bus = this.player.sahipOlunanOtobusler.find(b => b.id === busId);
                if (!bus) return;

                document.getElementById('busModifyName').textContent = `${bus.marka} ${bus.model}`;
                document.getElementById('busModifyCurrentSeats').textContent = `${bus.seatConfig.standard} Standart, ${bus.seatConfig.business} Business`;
                
                const modifyInput = document.getElementById('busModifyCount');
                const costLabel = document.getElementById('busModifyCost');
                const maxConvertable = Math.floor(bus.seatConfig.standard / 2);
                modifyInput.max = maxConvertable;
                modifyInput.value = 1;

                const updateCost = () => {
                    const count = parseInt(modifyInput.value) || 0;
                    if (count > 0 && count <= maxConvertable) {
                        costLabel.textContent = `Maliyet: ${(count * bus.modificationCost).toLocaleString()} TL | Sonuç: +${count} Business, -${count*2} Standart`;
                    } else {
                        costLabel.textContent = 'Geçersiz miktar';
                    }
                };
                
                modifyInput.oninput = updateCost;
                updateCost();

                const confirmBtn = document.getElementById('btnBusModifyConfirm');
                confirmBtn.onclick = () => {
                    const count = parseInt(modifyInput.value);
                    if (count > 0 && count <= maxConvertable) {
                        bus.modifySeatsToBusiness(count);
                    }
                };

                this.openModal('modalBusModify');
            },

            async prepareDigerSirketlerModal() {
                if (!this.player) return;
                const liste = document.getElementById('digerSirketlerListesi');
                const loading = document.getElementById('digerSirketlerLoading');
                liste.innerHTML = '';
                loading.classList.remove('hidden');

                try {
                    const q = query(collection(db, `artifacts/${appId}/public/data/company_profiles`), orderBy("toplamVarlik", "desc"), limit(50));
                    const querySnapshot = await getDocs(q);
                    let companies = [];
                    querySnapshot.forEach(doc => { if (doc.id !== userId) companies.push({ id: doc.id, ...doc.data() }); });
                    
                    if (companies.length === 0) {
                        liste.innerHTML = '<p class="text-gray-400 text-center col-span-full">Başka aktif şirket yok.</p>';
                    } else {
                        companies.forEach(c => {
                            liste.innerHTML += `
                                <div class="bg-gray-700 p-4 rounded-lg shadow flex flex-col items-center text-center">
                                    <img src="${c.sirketLogosu || 'https://placehold.co/80x80/4A5568/E2E8F0?text=LOGO'}" alt="${c.sirketAdi}" class="w-20 h-20 rounded-full mb-3 border-2 border-gray-500 object-cover">
                                    <h4 class="text-lg font-semibold text-white">${c.sirketAdi}</h4>
                                    <p class="text-sm text-gray-400">Seviye: ${c.seviye || 1}</p>
                                    <p class="text-sm text-yellow-400">Varlık: ${c.toplamVarlik?.toLocaleString() || 0} TL</p>
                                    <p class="text-xs text-gray-500 mt-1">Son Aktif: ${formatFirestoreTimestamp(c.lastPlayed)}</p>
                                </div>`;
                        });
                    }
                } catch (error) {
                    console.error("Diğer şirketler yüklenirken hata: ", error);
                    liste.innerHTML = '<p class="text-red-400 text-center col-span-full">Hata oluştu.</p>';
                } finally {
                    loading.classList.add('hidden');
                }
            },
            
            kontrolEtVeBaslatPlanlanmisSeferler() {
                if (!this.player || !this.player.planlanmisSeferler || !this.oyunTarihi) return;

                const baslatilacaklar = [];
                const kalanPlanlar = [];

                this.player.planlanmisSeferler.forEach(plan => {
                    const planZamani = new Date(plan.planlananTarih);
                    if (planZamani <= this.oyunTarihi) {
                        const otobus = this.player.sahipOlunanOtobusler.find(b => b.id === plan.otobusId);
                        const kalkisOtogari = this.mevcutOtogarlar.find(o => o.ad === plan.rota.kalkisAd);
                        
                        if (otobus && otobus.durum === 'garajda' && (plan.rotaTipi === 'Şehir İçi' || otobus.konum === kalkisOtogari?.ad)) {
                             let kalkisNoktasi, varisNoktasi, araDurakNoktasi;
                             if(plan.rotaTipi === 'Şehir İçi'){
                                kalkisNoktasi = new Durak(null, plan.rota.kalkisAd);
                                varisNoktasi = new Durak(null, plan.rota.varisAd);
                                // şehir içi planlarda ara durak yok şimdilik
                             } else {
                                kalkisNoktasi = this.mevcutOtogarlar.find(o => o.ad === plan.rota.kalkisAd);
                                varisNoktasi = this.mevcutOtogarlar.find(o => o.ad === plan.rota.varisAd);
                                araDurakNoktasi = plan.rota.araDurakAd ? this.mevcutOtogarlar.find(o => o.ad === plan.rota.araDurakAd) : null;
                             }

                            const rota = new Route(kalkisNoktasi, varisNoktasi, araDurakNoktasi, plan.rotaTipi);
                            rota.pricingConfig = plan.pricingConfig;
                            
                            const gerekliYakit = otobus.yakitTuketimiHesapla(rota.toplamMesafe, rota);

                            const event = this.getEventForRoute(kalkisNoktasi.ad, varisNoktasi.ad);
                            if (event && event.effects.routeBlocked) {
                                this.logMessage(`Planlanmış sefer (Otobüs ID: ${otobus.id}) rota (${event.description}) nedeniyle kapalı olduğu için iptal edildi!`, 'error');
                            } else if (otobus.yakitSeviyesi >= gerekliYakit) {
                                baslatilacaklar.push({ otobus, rota, planZamani });
                            } else {
                                this.logMessage(`Planlanmış sefer (Otobüs ID: ${otobus.id}) yakıt yetersizliği (${otobus.yakitSeviyesi.toFixed(1)}L/${gerekliYakit.toFixed(1)}L) nedeniyle başlatılamadı!`, 'error');
                                kalanPlanlar.push(plan); 
                            }
                        } else {
                            if(otobus) this.logMessage(`Planlanmış sefer (Otobüs ID: ${plan.otobusId}) otobüs meşgul (${otobus.durum}) veya yanlış konumda (${otobus.konum}) olduğu için başlatılamadı!`, 'error');
                            kalanPlanlar.push(plan); 
                        }
                    } else {
                        kalanPlanlar.push(plan);
                    }
                });
                
                this.player.planlanmisSeferler = kalanPlanlar;

                baslatilacaklar.forEach(({otobus, rota, planZamani}) => {
                    rota.calculatePassengerDemandAndRevenue(otobus, planZamani);
                    if (otobus.sefereBasla(rota)) {
                        rota.aktif = true;
                        this.aktifSeferlerDetayli.push({
                            otobus, rota,
                            kalanSure: rota.tahminiSure,
                        });
                        this.logMessage(`Planlanmış sefer (Otobüs ID: ${otobus.id}) otomatik olarak başlatıldı.`);
                    }
                });

                if (baslatilacaklar.length > 0) this.updateUI();
            },

            getYolcuTalebiCarpanı(varisAd, rotaTipi = 'Şehirler Arası') {
                if (!this.oyunTarihi) return 1.0;
                let carpan = 1.0;
                const saat = this.oyunTarihi.getHours();
                const ay = this.oyunTarihi.getMonth(); 

                if ((saat >= 7 && saat <= 9) || (saat >= 17 && saat <= 19)) carpan *= 1.25; 
                else if (saat >= 23 || saat <= 4) carpan *= 0.8; 

                if(rotaTipi === 'Şehirler Arası'){
                     if (ay >= 5 && ay <= 7) carpan *= 1.3; 
                     else if (ay === 0 || ay === 1 || ay === 11) carpan *= 0.9;
                }
                
                const varisOtogari = this.mevcutOtogarlar.find(o => o.ad === varisAd);
                if(varisOtogari) {
                    const event = this.activeEvents.find(e => e.type === 'FESTIVAL' && e.location.sehir === varisOtogari.sehir);
                    if (event && event.effects.demandMultiplier) {
                        carpan *= event.effects.demandMultiplier;
                    }
                }
                
                return carpan;
            },

            guncelleYakitFiyati() {
                const degisim = (Math.random() - 0.48) * 0.5; 
                this.yakitFiyatiLitre += degisim;
                this.yakitFiyatiLitre = Math.max(15.0, Math.min(50.0, this.yakitFiyatiLitre)); 
                this.logMessage(`Akaryakıt fiyatları güncellendi! Yeni Fiyat: ${this.yakitFiyatiLitre.toFixed(2)} TL/Litre`, "info");
                
                this.yakitFiyatGecmisi.push(this.yakitFiyatiLitre);
                if (this.yakitFiyatGecmisi.length > 24) this.yakitFiyatGecmisi.shift();

                document.getElementById('yakitFiyati').textContent = this.yakitFiyatiLitre.toFixed(2);
                if (document.getElementById('modalYakit').classList.contains('flex')) {
                    this.renderYakitGrafigi();
                }
            },

            renderYakitGrafigi() {
                const ctx = document.getElementById('yakitGrafigi')?.getContext('2d');
                if (!ctx) return;
                if (this.yakitGrafikInstance) this.yakitGrafikInstance.destroy();

                const dataPoints = this.yakitFiyatGecmisi;
                const labels = dataPoints.map((_, index) => `${(dataPoints.length - index -1) * 15} dk önce`);

                this.yakitGrafikInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.reverse(),
                        datasets: [{
                            label: 'Yakıt Fiyatı (TL)',
                            data: dataPoints,
                            borderColor: 'rgba(59, 130, 246, 0.8)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderWidth: 2, pointRadius: 3, pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            fill: true, tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: false, ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#9CA3AF', display: false }, grid: { display: false } } },
                        plugins: { legend: { labels: { color: '#E5E7EB' } }, tooltip: { callbacks: { label: function(context) { return `Fiyat: ${context.raw.toFixed(2)} TL`; } } } }
                    }
                });
            },

            startGameLoop() {
                if (this.gameLoopInterval) return;
                this.lastTickTime = Date.now();
                this.gameLoopInterval = setInterval(() => this.gameTick(), 1000); 
                this.logMessage("Oyun zamanı otomatik olarak ilerlemeye başladı.");
            },
    
            stopGameLoop() {
                if (this.gameLoopInterval) {
                    clearInterval(this.gameLoopInterval);
                    this.gameLoopInterval = null;
                    this.logMessage("Oyun zamanı durduruldu.");
                }
            },
    
            gameTick() {
                if (!this.player || !this.oyunTarihi || !this.isAuthReady) return;
    
                const now = Date.now();
                const deltaSeconds = (now - this.lastTickTime) / 1000;
                this.lastTickTime = now;
    
                // 1 gerçek saniye = 1 oyun saniyesi (1 oyun günü = 24 saat)
                const gameSecondsPassed = deltaSeconds; 
                const gameHoursPassed = gameSecondsPassed / 3600;
                
                const oncekiAyStr = `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;
                this.oyunTarihi = new Date(this.oyunTarihi.getTime() + gameSecondsPassed * 1000);
                const simdikiAyStr = `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;

                if (simdikiAyStr !== oncekiAyStr) {
                    this.player.aylikGiderleriOde(oncekiAyStr);
                    const finalRecord = this.getOrCreateFinancialRecord(oncekiAyStr);
                    const totalExpenses = Object.values(finalRecord.expenses).reduce((a, b) => a + b, 0);
                    finalRecord.netProfit = finalRecord.income - totalExpenses;
                    this.logMessage(`${oncekiAyStr} ayı mali raporu tamamlandı. Net Kâr/Zarar: ${finalRecord.netProfit.toLocaleString()} TL`, 'info');
                    
                    this.lastFinancialReportMonth = simdikiAyStr;
                    this.getOrCreateFinancialRecord(simdikiAyStr);
                }
                
                this.fuelPriceUpdateCounter += deltaSeconds;
                if (this.fuelPriceUpdateCounter >= 900) { // 900 saniye = 15 dakika
                    this.guncelleYakitFiyati();
                    this.fuelPriceUpdateCounter = 0;
                }
                
                this.checkAndTriggerEvents();
                document.getElementById('oyunTarihi').textContent = formatGameDate(this.oyunTarihi);
                this.kontrolEtVeBaslatPlanlanmisSeferler();
    
                let tripEventOccurred = false;
                const tamamlananlar = [];
                this.aktifSeferlerDetayli.forEach(sefer => {
                    const { otobus, rota } = sefer;
                    if (!rota.aktif) {
                        tamamlananlar.push(sefer);
                        tripEventOccurred = true;
                        return;
                    }
                    
                    const event = this.getEventForRoute(rota.kalkisNoktasi.ad, rota.varisNoktasi.ad);
                    if (event && event.effects.routeBlocked) {
                         this.logMessage(`DİKKAT! ${otobus.marka} seferi (${event.description}) nedeniyle iptal oldu!`, "error");
                         otobus.durum = "garajda";
                         otobus.konum = rota.kalkisNoktasi.ad;
                         const sofor = this.player.personelListesi.find(s => s.id === otobus.atananSoforId);
                         if(sofor) sofor.durum = "Boşta";
                         rota.aktif = false;
                         tamamlananlar.push(sefer);
                         tripEventOccurred = true;
                         return;
                    }
    
                    sefer.kalanSure -= gameHoursPassed;
                    const gidilenMesafe = otobus.getEffectiveSpeed() * gameHoursPassed;
                    otobus.yakitSeviyesi -= otobus.yakitTuketimiHesapla(gidilenMesafe, rota);
    
                    if (otobus.yakitSeviyesi <= 0) {
                        otobus.yakitSeviyesi = 0;
                        otobus.durum = "arizali";
                        this.logMessage(`DİKKAT! ${otobus.marka} yakıtı bitti! Sefer iptal.`, "error");
                        this.player.para -= Math.floor(rota.finalRevenue * 0.5);
                        rota.aktif = false;
                        tamamlananlar.push(sefer);
                        tripEventOccurred = true;
                    } else if (sefer.kalanSure <= 0) {
                        this.player.para += rota.finalRevenue;
                        this.recordIncome(rota.finalRevenue);
                        this.player.xpKazan(Math.floor(rota.toplamMesafe * 0.1));
                        
                        if (this.player.stats) {
                            const yolcuSayisi = rota.passengerManifest.standard + rota.passengerManifest.business;
                            this.player.stats.totalPassengers = (this.player.stats.totalPassengers || 0) + yolcuSayisi;
                            this.player.stats.totalKm = (this.player.stats.totalKm || 0) + rota.toplamMesafe;

                            const routeKey = `${rota.kalkisNoktasi.ad}-${rota.varisNoktasi.ad}`;
                            if (!this.player.stats.routePopularity[routeKey]) {
                                this.player.stats.routePopularity[routeKey] = { count: 0, revenue: 0 };
                            }
                            this.player.stats.routePopularity[routeKey].count++;
                            this.player.stats.routePopularity[routeKey].revenue += rota.finalRevenue;

                            if (!this.player.stats.tripCompletionHours) {
                                this.player.stats.tripCompletionHours = [];
                            }
                            this.player.stats.tripCompletionHours.push(this.oyunTarihi.getHours());
                            if (this.player.stats.tripCompletionHours.length > 500) { // Limit array size
                                this.player.stats.tripCompletionHours.shift();
                            }

                            const sofor = this.player.personelListesi.find(s => s.id === otobus.atananSoforId);
                            const avgStandardSat = otobus.getMemnuniyetBonusu('standard');
                            const avgBusinessSat = otobus.getMemnuniyetBonusu('business');
                            const totalSatPoints = (rota.passengerManifest.standard * avgStandardSat) + (rota.passengerManifest.business * avgBusinessSat);
                            const avgSatisfactionScore = yolcuSayisi > 0 ? (totalSatPoints / yolcuSayisi) * 90 - (sofor ? sofor.yorgunluk / 5 : 20) : 50;

                            this.player.stats.satisfactionHistory.push(Math.max(0, Math.min(100, avgSatisfactionScore)));
                            if (this.player.stats.satisfactionHistory.length > 100) {
                                this.player.stats.satisfactionHistory.shift();
                            }
                        }

                        otobus.seferiTamamla();
                        rota.aktif = false;
                        tamamlananlar.push(sefer);
                        tripEventOccurred = true;
                    }
                });
    
                if (tamamlananlar.length > 0) {
                    this.aktifSeferlerDetayli = this.aktifSeferlerDetayli.filter(s => !tamamlananlar.includes(s));
                }
    
                if (tripEventOccurred) {
                    this.updateUI();
                    this.savePlayerData();
                }
            },

            checkAndTriggerEvents() {
                if (!this.oyunTarihi || this.lastEventCheckHour === null) return;
                
                const activeEventsBefore = this.activeEvents.length;
                this.activeEvents = this.activeEvents.filter(event => event.expiryDate > this.oyunTarihi);
                if (this.activeEvents.length < activeEventsBefore) {
                    this.logMessage("Bazı yol olayları sona erdi.", "info");
                    this.updateEventsUI();
                }

                const currentHour = this.oyunTarihi.getHours();
                if (currentHour !== this.lastEventCheckHour) {
                    this.lastEventCheckHour = currentHour;
                    if (this.player.erisilebilirOtogarlar.length > 1 && Math.random() < EVENT_TRIGGER_CHANCE_PER_HOUR) {
                        this.createRandomEvent();
                    }
                }
            },

            createRandomEvent() {
                const eventTypes = [
                    { type: 'FESTIVAL', weight: 3 },
                    { type: 'ROAD_WORK', weight: 4 },
                    { type: 'ACCIDENT', weight: 2 },
                ];
                const totalWeight = eventTypes.reduce((sum, e) => sum + e.weight, 0);
                let random = Math.random() * totalWeight;
                const chosenType = eventTypes.find(e => (random -= e.weight) < 0).type;

                const acikOtogarlar = this.mevcutOtogarlar.filter(o => o.acikMi);
                if (acikOtogarlar.length < 2) return;
                
                let newEvent = {
                    id: `event_${Date.now()}`,
                    type: chosenType,
                    expiryDate: new Date(),
                    description: '',
                    location: { kalkis: null, varis: null, sehir: null },
                    effects: {}
                };

                if (chosenType === 'FESTIVAL') {
                    const durationDays = Math.floor(Math.random() * 3) + 1; // 1-3 gün arası
                    newEvent.expiryDate = new Date(this.oyunTarihi.getTime() + durationDays * 24 * 60 * 60 * 1000);
                    const targetOtogar = acikOtogarlar[Math.floor(Math.random() * acikOtogarlar.length)];
                    newEvent.location.sehir = targetOtogar.sehir;
                    newEvent.description = `🎉 ${targetOtogar.sehir}'de festival var! Şehre olan yolcu talebi arttı!`;
                    newEvent.effects = { demandMultiplier: 2.5 };
                } else {
                    const idx1 = Math.floor(Math.random() * acikOtogarlar.length);
                    let idx2 = Math.floor(Math.random() * acikOtogarlar.length);
                    while (idx1 === idx2) idx2 = Math.floor(Math.random() * acikOtogarlar.length);
                    
                    const otogar1 = acikOtogarlar[idx1];
                    const otogar2 = acikOtogarlar[idx2];
                    newEvent.location.kalkis = otogar1;
                    newEvent.location.varis = otogar2;

                    if (chosenType === 'ROAD_WORK') {
                        const durationHours = Math.random() * 2; // Maksimum 2 saat
                        newEvent.expiryDate = new Date(this.oyunTarihi.getTime() + durationHours * 60 * 60 * 1000);
                        const delayHours = (durationHours * 0.5 + 0.5).toFixed(1); // Gecikme, sürenin bir parçası
                        newEvent.description = `🚧 ${otogar1.sehir} - ${otogar2.sehir} arasında yol çalışması var. Seferler ${delayHours} saat gecikecek.`;
                        newEvent.effects = { timePenaltyHours: parseFloat(delayHours) };
                    } else if (chosenType === 'ACCIDENT') {
                        const durationHours = 1; // 1 saat
                        newEvent.expiryDate = new Date(this.oyunTarihi.getTime() + durationHours * 60 * 60 * 1000);
                        newEvent.description = `💥 ${otogar1.sehir} - ${otogar2.sehir} arasındaki yolda kaza oldu! Rota 1 saatliğine kapandı.`;
                        newEvent.effects = { routeBlocked: true };
                    }
                }

                const exists = this.activeEvents.some(e => e.type === newEvent.type && JSON.stringify(e.location) === JSON.stringify(newEvent.location));
                if (!exists) {
                    this.activeEvents.push(newEvent);
                    this.logMessage(`YENİ OLAY: ${newEvent.description}`, "warning");
                    this.updateEventsUI();
                }
            },
            
            getEventForRoute(kalkisAd, varisAd) {
                return this.activeEvents.find(event => {
                    if (event.location.kalkis && event.location.varis) {
                        const eventKalkis = event.location.kalkis.ad;
                        const eventVaris = event.location.varis.ad;
                        return (eventKalkis === kalkisAd && eventVaris === varisAd) || (eventKalkis === varisAd && eventVaris === kalkisAd);
                    }
                    return false;
                });
            },

            getOrCreateFinancialRecord(monthStr) {
                if (!this.player) return null;
                let record = this.player.financialHistory.find(r => r.month === monthStr);
                if (!record) {
                    record = {
                        month: monthStr,
                        income: 0,
                        expenses: { salaries: 0, fuel: 0, maintenance: 0, assetPurchase: 0, recruitment: 0 },
                        netProfit: 0
                    };
                    this.player.financialHistory.push(record);
                }
                return record;
            },

            recordIncome(amount, monthStr = null) {
                if (!this.player || !amount) return;
                const currentMonthStr = monthStr || `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;
                const financialRecord = this.getOrCreateFinancialRecord(currentMonthStr);
                financialRecord.income = (financialRecord.income || 0) + amount;
            },

            recordExpense(type, amount, monthStr = null) {
                if (!this.player || !amount) return;
                const currentMonthStr = monthStr || `${this.oyunTarihi.getFullYear()}-${String(this.oyunTarihi.getMonth() + 1).padStart(2, '0')}`;
                const financialRecord = this.getOrCreateFinancialRecord(currentMonthStr);
                financialRecord.expenses[type] = (financialRecord.expenses[type] || 0) + amount;
            },

            prepareSirketimModal() {
                if (!this.player) return;
                this.updateSirketPaneliUI();

                const financialHistory = this.player.financialHistory || [];
                const sonAyLabel = document.getElementById('sonAyLabel');
                const sonAyDokumu = document.getElementById('sonAyDokumu');

                if (financialHistory.length > 0) {
                    const lastMonth = financialHistory.slice().sort((a,b) => a.month.localeCompare(b.month)).pop();
                    sonAyLabel.textContent = lastMonth.month;
                    
                    const formatCurrency = (amount) => (amount || 0).toLocaleString() + ' TL';
                    const exp = lastMonth.expenses;
                    const totalExpenses = (exp.salaries || 0) + (exp.fuel || 0) + (exp.maintenance || 0) + (exp.assetPurchase || 0) + (exp.recruitment || 0);
                    const netProfit = lastMonth.income - totalExpenses;
                    const profitColor = netProfit >= 0 ? 'text-green-400' : 'text-red-400';

                    sonAyDokumu.innerHTML = `
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-sm text-gray-400">Toplam Gelir</p>
                            <p class="text-2xl font-bold text-green-400">${formatCurrency(lastMonth.income)}</p>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-sm text-gray-400">Toplam Gider</p>
                            <p class="text-2xl font-bold text-red-400">${formatCurrency(totalExpenses)}</p>
                            <div class="text-left text-xs text-gray-400 mt-1 space-y-0.5">
                                <p>Maaş: ${formatCurrency(exp.salaries)}</p>
                                <p>Yakıt: ${formatCurrency(exp.fuel)}</p>
                                <p>Bakım/Yükseltme: ${formatCurrency(exp.maintenance)}</p>
                                <p>Varlık Alımı: ${formatCurrency(exp.assetPurchase)}</p>
                                <p>İşe Alım: ${formatCurrency(exp.recruitment)}</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <p class="text-sm text-gray-400">Net Kâr/Zarar</p>
                            <p class="text-2xl font-bold ${profitColor}">${formatCurrency(netProfit)}</p>
                        </div>
                    `;
                } else {
                    sonAyLabel.textContent = 'Veri Yok';
                    sonAyDokumu.innerHTML = '<p class="col-span-full text-center text-gray-400">Henüz tamamlanmış bir ay yok.</p>';
                }
                this.renderMaliRaporGrafigi();

                const stats = this.player.stats || {};
                const statsList = document.getElementById('operasyonelStatsList');
                
                let mostPopularRoute = 'Yok';
                let maxTrips = 0;
                if (stats.routePopularity && Object.keys(stats.routePopularity).length > 0) {
                    for (const route in stats.routePopularity) {
                        if (stats.routePopularity[route].count > maxTrips) {
                            maxTrips = stats.routePopularity[route].count;
                            mostPopularRoute = route.replace('-', ' → ');
                        }
                    }
                }
                if(maxTrips > 0) mostPopularRoute += ` (${maxTrips} sefer)`;

                let avgSatisfaction = 'N/A';
                if (stats.satisfactionHistory && stats.satisfactionHistory.length > 0) {
                    const sum = stats.satisfactionHistory.reduce((a, b) => a + b, 0);
                    avgSatisfaction = (sum / stats.satisfactionHistory.length).toFixed(1) + ' / 100';
                }

                statsList.innerHTML = `
                    <div class="bg-gray-700 p-4 rounded-lg"><p class="text-lg font-semibold">Toplam Taşınan Yolcu</p><p class="text-3xl font-bold text-blue-400">${(stats.totalPassengers || 0).toLocaleString()}</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><p class="text-lg font-semibold">Filo Toplam Kilometre</p><p class="text-3xl font-bold text-blue-400">${(stats.totalKm || 0).toLocaleString()} km</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><p class="text-lg font-semibold">Genel Yolcu Memnuniyeti</p><p class="text-3xl font-bold text-blue-400">${avgSatisfaction}</p></div>
                    <div class="bg-gray-700 p-4 rounded-lg"><p class="text-lg font-semibold">En Popüler Hat</p><p class="text-2xl font-bold text-blue-400 break-words">${mostPopularRoute}</p></div>
                `;
            },

            renderMaliRaporGrafigi() {
                const ctx = document.getElementById('maliRaporGrafigi')?.getContext('2d');
                if (!ctx || !this.player) return;
                if (this.maliRaporGrafikInstance) this.maliRaporGrafikInstance.destroy();

                const history = this.player.financialHistory.slice(-12);
                const labels = history.map(r => r.month);
                const incomeData = history.map(r => r.income);
                const expenseData = history.map(r => {
                    const exp = r.expenses;
                    return (exp.salaries || 0) + (exp.fuel || 0) + (exp.maintenance || 0) + (exp.assetPurchase || 0) + (exp.recruitment || 0);
                });
                const netProfitData = history.map(r => r.netProfit);

                this.maliRaporGrafikInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Gelir', data: incomeData, backgroundColor: 'rgba(74, 222, 128, 0.6)', borderColor: 'rgba(74, 222, 128, 1)', borderWidth: 1 },
                            { label: 'Gider', data: expenseData, backgroundColor: 'rgba(248, 113, 113, 0.6)', borderColor: 'rgba(248, 113, 113, 1)', borderWidth: 1 },
                            { label: 'Net Kâr', data: netProfitData, backgroundColor: 'rgba(96, 165, 250, 0.6)', borderColor: 'rgba(96, 165, 250, 1)', type: 'line', fill: false, tension: 0.2 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#9CA3AF' }, grid: { display: false } } },
                        plugins: { legend: { labels: { color: '#E5E7EB' } } }
                    }
                });
            },
            
            renderRotaAnalizi() {
                if (!this.player || !this.player.stats) return;

                // 1. En Kârlı Rotalar Listesini Oluştur
                const listContainer = document.getElementById('enKarliRotalarListesi');
                listContainer.innerHTML = '';
                const routePopularity = this.player.stats.routePopularity || {};
                const sortedRoutes = Object.entries(routePopularity)
                    .map(([key, value]) => ({ route: key, ...value }))
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 10); // En iyi 10

                if (sortedRoutes.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-400">Henüz yeterli rota verisi yok.</p>';
                } else {
                    sortedRoutes.forEach((item, index) => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                        div.innerHTML = `
                            <div>
                                <span class="font-bold text-indigo-400 mr-2">#${index + 1}</span>
                                <span class="font-semibold">${item.route.replace('-', ' → ')}</span>
                            </div>
                            <div>
                                <span class="text-green-400 font-bold">${item.revenue.toLocaleString()} TL</span>
                                <span class="text-gray-400 text-sm ml-2">(${item.count} sefer)</span>
                            </div>
                        `;
                        listContainer.appendChild(div);
                    });
                }

                // 2. En Yoğun Saatler Grafiğini Oluştur
                const ctx = document.getElementById('rotaYogunlukGrafigi')?.getContext('2d');
                if (!ctx) return;
                if (this.rotaYogunlukGrafikInstance) this.rotaYogunlukGrafikInstance.destroy();

                const tripHours = this.player.stats.tripCompletionHours || [];
                const hourCounts = Array(24).fill(0);
                tripHours.forEach(hour => {
                    if (hour >= 0 && hour < 24) {
                        hourCounts[hour]++;
                    }
                });

                this.rotaYogunlukGrafikInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`),
                        datasets: [{
                            label: 'Tamamlanan Sefer Sayısı',
                            data: hourCounts,
                            backgroundColor: 'rgba(34, 211, 238, 0.6)',
                            borderColor: 'rgba(34, 211, 238, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#9CA3AF', stepSize: 1 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: '#9CA3AF' }, grid: { display: false } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `Saat: ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        return `Sefer Sayısı: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => game.init());
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #2d3748; border-radius: 10px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px;}
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 5px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="checkbox"] { accent-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col min-h-screen">
    <div id="modalAuth" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center p-4 z-[10003]">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 id="authModalTitle" class="text-2xl font-semibold mb-6 text-center text-white">Giriş Yap</h3>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" required class="w-full p-3 bg-gray-700 rounded-md" placeholder="E-posta">
                <input type="password" id="loginPassword" required class="w-full p-3 bg-gray-700 rounded-md" placeholder="Şifre">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg">Giriş Yap</button>
                <p class="text-center text-sm text-gray-400">Hesabın yok mu? <a href="#" id="showRegister" class="text-blue-400 hover:underline">Kayıt Ol</a></p>
            </form>
            <form id="registerForm" class="space-y-4 hidden">
                <input type="email" id="registerEmail" required class="w-full p-3 bg-gray-700 rounded-md" placeholder="E-posta">
                <input type="password" id="registerPassword" required minlength="6" class="w-full p-3 bg-gray-700 rounded-md" placeholder="Şifre (en az 6 karakter)">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg">Kayıt Ol</button>
                <p class="text-center text-sm text-gray-400">Zaten hesabın var mı? <a href="#" id="showLogin" class="text-blue-400 hover:underline">Giriş Yap</a></p>
            </form>
            <p id="authMessage" class="text-center text-sm mt-4"></p>
        </div>
    </div>

    <div id="gameContainer" class="hidden">
        <header class="bg-gray-800 shadow-md p-4">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white">Anatolia Bus Manager</h1>
                <div>
                    <span id="userEmailDisplay" class="text-sm text-gray-300 mr-4"></span>
                    <button id="btnLogout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Çıkış Yap</button>
                </div>
            </div>
            <p id="userIdDisplay" class="text-xs text-center text-gray-400 mt-1">Giriş Yapılmadı</p>
        </header>

        <main class="flex-grow container mx-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col overflow-hidden lg:col-span-1">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Operasyon Merkezi</h2>
                <div class="flex flex-col flex-grow overflow-hidden h-[60vh] md:h-auto">
                    <h3 class="text-lg font-medium mb-2">Aktif Seferler</h3>
                    <ul id="aktifSeferlerList" class="space-y-2 overflow-y-auto custom-scrollbar pr-2 flex-grow mb-4"></ul>
                    <h3 class="text-lg font-medium mb-2 border-t border-gray-700 pt-2">Planlanmış Seferler</h3>
                    <ul id="planlanmisSeferlerList" class="space-y-2 overflow-y-auto custom-scrollbar pr-2 flex-grow"></ul>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col lg:col-span-1">
                <div class="flex items-center justify-between mb-3 border-b border-gray-700 pb-2">
                    <h2 id="sirketPaneliBaslik" class="text-xl font-semibold">Şirket Paneli</h2>
                    <img id="sirketPaneliLogo" class="w-10 h-10 rounded-full hidden">
                </div>
                <div class="space-y-2 mb-4">
                    <p>💰 <strong>Para:</strong> <span id="playerMoney">0 TL</span></p>
                    <p>⭐ <strong>Deneyim (XP):</strong> <span id="playerXP">0 / 100</span></p>
                    <p>🏆 <strong>Seviye:</strong> <span id="playerLevel">1</span></p>
                    <p>👨‍✈️ <strong>Personel:</strong> <span id="playerSoforSayisi">0</span></p>
                    <p>📅 <strong>Oyun Tarihi:</strong> <span id="oyunTarihi">...</span></p>
                    <p>⛽ <strong>Yakıt Fiyatı:</strong> <span id="yakitFiyati">0.00</span> TL/Litre</p>
                </div>
                
                <h3 class="text-lg font-medium mb-2 pt-2 border-t border-gray-700">Mali Durum</h3>
                <div class="space-y-1 mb-4 text-sm">
                    <p><strong>Toplam Varlık:</strong> <span id="playerTotalAssets">0 TL</span></p>
                    <p><strong>Otobüs Varlıkları:</strong> <span id="playerBusAssets">0 TL (0 otobüs)</span></p>
                </div>
                
                <h3 class="text-lg font-medium mb-2 pt-2 border-t border-gray-700">Güncel Olaylar</h3>
                <ul id="activeEventsList" class="space-y-1 overflow-y-auto custom-scrollbar pr-2 flex-grow h-24">
                     <li class="text-gray-400 italic">Şu anda önemli bir olay yok.</li>
                </ul>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col lg:col-span-1">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Oyun Kayıtları</h2>
                <div id="gameLog" class="flex-grow bg-gray-900 p-2 rounded-md text-xs overflow-y-auto h-full custom-scrollbar"></div>
            </div>
        </main>

        <footer class="bg-gray-800 shadow-md p-4 mt-auto">
            <div class="container mx-auto grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-4 gap-2 text-center">
                 <div class="space-y-2">
                    <button id="btnSirketim" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow w-full hidden">Şirketim</button>
                    <button id="btnDukkan" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">Dükkan</button>
                </div>
                <div class="space-y-2">
                    <button id="btnGaraj" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">Garaj</button>
                    <button id="btnInsanKaynaklari" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">İnsan Kaynakları</button>
                </div>
                <div class="space-y-2">
                     <button id="btnOtogarYonetimi" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">Otogar Yönetimi</button>
                    <button id="btnDigerSirketler" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">Diğer Şirketler</button>
                </div>
                <div class="space-y-2">
                    <button id="btnRota" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">Rota Oluştur</button>
                    <button id="btnYakit" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow w-full">Yakıt Al</button>
                </div>
            </div>
        </footer>
    </div>

    <div id="modalIlkOtogarSec" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[10002]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col"><h3 class="text-2xl font-semibold mb-4 text-center">Başlangıç Otogarınızı Seçin</h3><div id="ilkOtogarSecListesi" class="overflow-y-auto custom-scrollbar pr-2 flex-grow grid grid-cols-1 sm:grid-cols-2 gap-3"></div></div></div>
    <div id="modalOtogarYonetimi" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Otogar Yönetimi</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="otogarYonetimiListesi" class="overflow-y-auto custom-scrollbar pr-2 flex-grow grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div></div></div>
    <div id="modalSirketKur" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[10001]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-semibold mb-4 text-center">Şirketinizi Kurun!</h3><div class="space-y-4"><input type="text" id="sirketAdiKurInput" placeholder="Anatolia Turizm A.Ş." class="w-full p-2 bg-gray-700 rounded-md"><input type="url" id="sirketLogosuKurInput" placeholder="Şirket Logosu URL (Opsiyonel)" class="w-full p-2 bg-gray-700 rounded-md"><button id="btnSirketKurOnayla" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Şirketi Kur</button></div></div></div>
    <div id="modalBusModify" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[10001]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Otobüs Modifikasyonu</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="space-y-4"><h4 id="busModifyName" class="text-lg font-semibold text-center"></h4><p class="text-sm text-center text-gray-300">Mevcut Koltuklar: <span id="busModifyCurrentSeats"></span></p><label for="busModifyCount" class="block text-sm">Business Class'a Dönüştürülecek Koltuk Sayısı:</label><input type="number" id="busModifyCount" min="1" class="w-full p-2 bg-gray-700 rounded-md"><p id="busModifyCost" class="text-sm text-yellow-400 text-center"></p><button id="btnBusModifyConfirm" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Onayla</button></div></div></div>
    
    <div id="modalSirketBilgileri" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[10000]">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold">Şirketim</h3>
                <button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="border-b border-gray-700 mb-4">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tabBtnGenel" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400">Genel Bilgiler</button>
                    <button id="tabBtnMali" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Mali Rapor</button>
                    <button id="tabBtnOperasyonel" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Operasyonel İstatistikler</button>
                    <button id="tabBtnRotaAnalizi" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Rota Analizi</button>
                </nav>
            </div>

            <div class="overflow-y-auto custom-scrollbar pr-2 flex-grow">
                <div id="tabContentGenel" class="tab-content">
                    <div class="space-y-4">
                        <div class="flex flex-col items-center">
                            <img id="sirketLogosuGoruntule" class="w-32 h-32 rounded-full mb-3 border-2 border-gray-500 object-cover">
                            <h4 id="sirketAdiGoruntule" class="text-xl font-semibold text-white">...</h4>
                        </div>
                        <input type="url" id="sirketLogosuInput" placeholder="Yeni Logo URL'si" class="w-full p-2 bg-gray-700 rounded-md">
                        <button id="btnSirketLogoGuncelle" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Logoyu Güncelle</button>
                    </div>
                </div>

                <div id="tabContentMali" class="tab-content hidden">
                    <h4 class="text-xl font-semibold mb-4">Aylık Gelir/Gider Grafiği (Son 12 Ay)</h4>
                    <div class="w-full h-64 mb-6 bg-gray-900 p-2 rounded"><canvas id="maliRaporGrafigi"></canvas></div>
                    <h4 class="text-xl font-semibold mb-4">Son Ayın Dökümü (<span id="sonAyLabel"></span>)</h4>
                    <div id="sonAyDokumu" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center"></div>
                </div>

                <div id="tabContentOperasyonel" class="tab-content hidden">
                    <h4 class="text-xl font-semibold mb-4">Tüm Zamanlar İstatistikleri</h4>
                    <div id="operasyonelStatsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                
                <div id="tabContentRotaAnalizi" class="tab-content hidden">
                    <h4 class="text-xl font-semibold mb-4">En Kârlı Rotalar (Top 10)</h4>
                    <div id="enKarliRotalarListesi" class="space-y-2 mb-6"></div>
                    <h4 class="text-xl font-semibold mb-4">Sefer Yoğunluk Saatleri</h4>
                    <div class="w-full h-64 bg-gray-900 p-2 rounded">
                        <canvas id="rotaYogunlukGrafigi"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modalDukkan" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Otobüs Dükkanı</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="dukkanOtobusListesi" class="overflow-y-auto custom-scrollbar pr-2 flex-grow"></div></div></div>
    <div id="modalGaraj" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Garaj & Personel</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="overflow-y-auto custom-scrollbar pr-2 flex-grow"><h4 class="text-lg font-semibold mb-2">Otobüsler (<span id="garajKapasite">0/0</span>)</h4><button id="btnGarajGenislet" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mb-3">Garajı Genişlet</button><div id="garajOtobusListesi" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4"></div><div id="personelDurumu" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div></div></div></div>
    <div id="modalSoforAta" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[10000]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Şoför Ata/Değiştir</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><input type="hidden" id="soforAtaBusId"><div><select id="soforAtaSelect" class="w-full p-2 bg-gray-700 rounded-md mb-3"></select><button id="btnSoforAtaOnayla" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Onayla</button></div></div></div>
    <div id="modalInsanKaynaklari" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-semibold">İnsan Kaynakları - Şoför Alımı</h3><div><button id="btnYeniAdayAra" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Yeni Aday Ara (10,000 TL)</button><button class="close-modal-btn text-gray-400 hover:text-white text-2xl ml-4">&times;</button></div></div><div id="insanKaynaklariListesi" class="overflow-y-auto custom-scrollbar pr-2 flex-grow grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div></div></div>
    <div id="modalRota" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[95vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Yeni Sefer Oluştur</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="space-y-3 overflow-y-auto custom-scrollbar pr-2"><div class="grid grid-cols-2 gap-4"><div class="col-span-1"><label for="rotaTipiSec" class="block text-sm font-medium mb-1">Sefer Tipi</label><select id="rotaTipiSec" class="w-full p-2 bg-gray-700 rounded-md"><option>Şehirler Arası</option><option>Şehir İçi</option></select></div><div class="col-span-1"><label for="rotaOtobusSec" class="block text-sm font-medium mb-1">Otobüs</label><select id="rotaOtobusSec" class="w-full p-2 bg-gray-700 rounded-md"></select></div></div><div id="sehirlerArasiContainer" class="space-y-3"><select id="rotaKalkisSec" class="w-full p-2 bg-gray-700 rounded-md"></select><div class="flex items-center"><input type="checkbox" id="rotaAraDurakEkleCheckbox" class="h-4 w-4"><label for="rotaAraDurakEkleCheckbox" class="ml-2 text-sm">Ara Durak Ekle</label></div><div id="rotaAraDurakContainer" class="hidden"><select id="rotaAraDurakSec" class="w-full p-2 bg-gray-700 rounded-md"></select></div><select id="rotaVarisSec" class="w-full p-2 bg-gray-700 rounded-md"></select></div><div id="sehirIciContainer" class="hidden space-y-3"><div class="grid grid-cols-2 gap-3"><select id="rotaKalkisIlceSec" class="w-full p-2 bg-gray-700 rounded-md"></select><select id="rotaKalkisDurakSec" class="w-full p-2 bg-gray-700 rounded-md"></select></div><div class="grid grid-cols-2 gap-3"><select id="rotaVarisIlceSec" class="w-full p-2 bg-gray-700 rounded-md"></select><select id="rotaVarisDurakSec" class="w-full p-2 bg-gray-700 rounded-md"></select></div></div><div class="p-3 bg-gray-900/50 rounded-lg space-y-3"><h4 class="text-md font-semibold text-center">Fiyatlandırma</h4><div class="grid grid-cols-2 gap-3"><label for="rotaStandardPrice" class="text-sm self-center">Standart Fiyatı:</label><input type="number" id="rotaStandardPrice" min="0" class="w-full p-2 bg-gray-700 rounded-md"></div><div id="businessPriceContainer" class="grid grid-cols-2 gap-3 hidden"><label for="rotaBusinessPrice" class="text-sm self-center">Business Fiyatı:</label><input type="number" id="rotaBusinessPrice" min="0" class="w-full p-2 bg-gray-700 rounded-md"></div><div class="flex items-center pt-2 border-t border-gray-600"><input type="checkbox" id="dynamicPricingToggle" class="h-4 w-4"><label for="dynamicPricingToggle" class="ml-2 text-sm">Dinamik Fiyatlandırmayı Aktif Et (Ş.Arası)</label></div></div><div id="rotaOlayUyarisi" class="mt-2 hidden"></div><div id="rotaOzeti" class="mt-2 p-3 bg-gray-700 rounded-md text-sm"></div><div class="mt-2"><label for="rotaTarihSaatInput" class="block text-sm font-medium mb-1">Kalkış Zamanı:</label><input type="datetime-local" id="rotaTarihSaatInput" class="w-full p-2 bg-gray-700 rounded-md"></div><div class="flex gap-2 mt-3"><button id="btnRotaHemenBaslat" class="w-1/2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">Hemen Başlat</button><button id="btnRotaPlanla" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">Sefer Planla</button></div></div></div></div>
    <div id="modalYakit" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold">Yakıt İstasyonu</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="w-full h-48 mb-4 bg-gray-900 p-2 rounded"><canvas id="yakitGrafigi"></canvas></div><p class="mb-3 text-sm">Güncel Yakıt Fiyatı: <span id="modalYakitFiyati" class="font-bold">0.00</span> TL/Litre</p><div class="space-y-3"><select id="yakitOtobusSec" class="w-full p-2 bg-gray-700 rounded-md"></select><input type="number" id="yakitMiktar" placeholder="Alınacak Miktar (Litre)" class="w-full p-2 bg-gray-700 rounded-md"><div class="flex space-x-2 mt-2"><button id="btnYakitAl" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">Yakıt Al</button><button id="btnYakitTamDoldur" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg">Tam Doldur</button></div></div></div></div>
    <div id="modalDigerSirketler" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-[9999]"><div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-semibold">Diğer Aktif Şirketler</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl">&times;</button></div><div id="digerSirketlerLoading" class="loader hidden"></div><div id="digerSirketlerListesi" class="overflow-y-auto custom-scrollbar pr-2 flex-grow grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div></div></div>

</body>
</html>
